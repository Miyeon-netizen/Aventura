
> aventura@0.1.1 check
> svelte-kit sync && svelte-check --tsconfig ./tsconfig.json

Loading svelte-check in workspace: /app
Getting Svelte diagnostics...

/app/vite.config.js:4:14
Error: Cannot find name 'process'. Do you need to install type definitions for node? Try `npm i --save-dev @types/node`.

const host = process.env.TAURI_DEV_HOST;

/app/src/lib/services/ai/agenticRetrieval.ts:240:46
Error: Property 'generateWithTools' does not exist on type 'AIProvider'.
      try {
        const response = await this.provider.generateWithTools({
          messages,

/app/src/lib/services/ai/loreManagement.ts:462:46
Error: Property 'generateWithTools' does not exist on type 'AIProvider'.
      try {
        const response = await this.provider.generateWithTools({
          messages,

/app/src/lib/components/debug/LorebookDebugPanel.svelte:46:5
Warn: Non-interactive element `<div>` should not be assigned mouse or keyboard event listeners
https://svelte.dev/e/a11y_no_noninteractive_element_interactions (svelte)
  >
    <div
      class="card w-full max-w-2xl max-h-[80vh] overflow-hidden"
      onclick={(e) => e.stopPropagation()}
      onkeydown={(e) => e.stopPropagation()}
      role="document"
    >
      <!-- Header -->
      <div class="flex items-center justify-between border-b border-surface-700 pb-4">
        <div class="flex items-center gap-2">
          <BookOpen class="h-5 w-5 text-accent-400" />
          <h2 class="text-xl font-semibold text-surface-100">Active Lorebook Entries</h2>
        </div>
        <button class="btn-ghost rounded-lg p-2" onclick={() => ui.closeLorebookDebug()}>
          <X class="h-5 w-5" />
        </button>
      </div>

      <!-- Content -->
      <div class="max-h-[60vh] overflow-y-auto py-4">
        {#if ui.lastLorebookRetrieval}
          {@const result = ui.lastLorebookRetrieval}
          {@const totalCount = result.tier1.length + result.tier2.length + result.tier3.length}

          <!-- Summary -->
          <div class="mb-4 p-3 rounded-lg bg-surface-800/50 border border-surface-700">
            <div class="flex items-center justify-between text-sm">
              <span class="text-surface-300">Total Active Entries:</span>
              <span class="font-medium text-surface-100">{totalCount}</span>
            </div>
            <div class="mt-2 flex gap-4 text-xs">
              <span class={tierColors[1].split(' ')[0]}>Tier 1: {result.tier1.length}</span>
              <span class={tierColors[2].split(' ')[0]}>Tier 2: {result.tier2.length}</span>
              <span class={tierColors[3].split(' ')[0]}>Tier 3: {result.tier3.length}</span>
            </div>
          </div>

          {#if totalCount === 0}
            <p class="text-center text-surface-400 py-8">
              No lorebook entries were activated for the last generation.
            </p>
          {:else}
            <!-- Tier 1: Always Active -->
            {#if result.tier1.length > 0}
              <div class="mb-4">
                <h3 class="text-sm font-medium text-green-400 mb-2 flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-green-400"></span>
                  Tier 1: {tierLabels[1]} ({result.tier1.length})
                </h3>
                <p class="text-xs text-surface-500 mb-2 ml-4">{tierDescriptions[1]}</p>
                <div class="space-y-2">
                  {#each result.tier1 as retrieved}
                    {@const Icon = getIcon(retrieved.entry.type)}
                    <div class="p-3 rounded-lg border {tierColors[1]}">
                      <div class="flex items-start gap-2">
                        <Icon class="h-4 w-4 mt-0.5 flex-shrink-0" />
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2">
                            <span class="font-medium text-surface-100">{retrieved.entry.name}</span>
                            <span class="text-xs px-1.5 py-0.5 rounded bg-surface-700 text-surface-400">
                              {retrieved.entry.type}
                            </span>
                          </div>
                          {#if retrieved.matchReason}
                            <p class="text-xs text-surface-500 mt-0.5">Reason: {retrieved.matchReason}</p>
                          {/if}
                          <p class="text-sm text-surface-300 mt-1 line-clamp-2">
                            {retrieved.entry.description}
                          </p>
                        </div>
                      </div>
                    </div>
                  {/each}
                </div>
              </div>
            {/if}

            <!-- Tier 2: Keyword Matched -->
            {#if result.tier2.length > 0}
              <div class="mb-4">
                <h3 class="text-sm font-medium text-amber-400 mb-2 flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                  Tier 2: {tierLabels[2]} ({result.tier2.length})
                </h3>
                <p class="text-xs text-surface-500 mb-2 ml-4">{tierDescriptions[2]}</p>
                <div class="space-y-2">
                  {#each result.tier2 as retrieved}
                    {@const Icon = getIcon(retrieved.entry.type)}
                    <div class="p-3 rounded-lg border {tierColors[2]}">
                      <div class="flex items-start gap-2">
                        <Icon class="h-4 w-4 mt-0.5 flex-shrink-0" />
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2">
                            <span class="font-medium text-surface-100">{retrieved.entry.name}</span>
                            <span class="text-xs px-1.5 py-0.5 rounded bg-surface-700 text-surface-400">
                              {retrieved.entry.type}
                            </span>
                          </div>
                          {#if retrieved.matchReason}
                            <p class="text-xs text-surface-500 mt-0.5">Matched: {retrieved.matchReason}</p>
                          {/if}
                          <p class="text-sm text-surface-300 mt-1 line-clamp-2">
                            {retrieved.entry.description}
                          </p>
                        </div>
                      </div>
                    </div>
                  {/each}
                </div>
              </div>
            {/if}

            <!-- Tier 3: LLM Selected -->
            {#if result.tier3.length > 0}
              <div class="mb-4">
                <h3 class="text-sm font-medium text-purple-400 mb-2 flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                  Tier 3: {tierLabels[3]} ({result.tier3.length})
                </h3>
                <p class="text-xs text-surface-500 mb-2 ml-4">{tierDescriptions[3]}</p>
                <div class="space-y-2">
                  {#each result.tier3 as retrieved}
                    {@const Icon = getIcon(retrieved.entry.type)}
                    <div class="p-3 rounded-lg border {tierColors[3]}">
                      <div class="flex items-start gap-2">
                        <Icon class="h-4 w-4 mt-0.5 flex-shrink-0" />
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2">
                            <span class="font-medium text-surface-100">{retrieved.entry.name}</span>
                            <span class="text-xs px-1.5 py-0.5 rounded bg-surface-700 text-surface-400">
                              {retrieved.entry.type}
                            </span>
                          </div>
                          {#if retrieved.matchReason}
                            <p class="text-xs text-surface-500 mt-0.5">Reason: {retrieved.matchReason}</p>
                          {/if}
                          <p class="text-sm text-surface-300 mt-1 line-clamp-2">
                            {retrieved.entry.description}
                          </p>
                        </div>
                      </div>
                    </div>
                  {/each}
                </div>
              </div>
            {/if}
          {/if}

          <!-- Context Block Preview -->
          {#if result.contextBlock}
            <div class="mt-4 border-t border-surface-700 pt-4">
              <h3 class="text-sm font-medium text-surface-300 mb-2">Injected Context Block</h3>
              <pre class="p-3 rounded-lg bg-surface-900 text-xs text-surface-400 overflow-x-auto max-h-48 overflow-y-auto font-mono whitespace-pre-wrap">{result.contextBlock}</pre>
            </div>
          {/if}
        {:else}
          <p class="text-center text-surface-400 py-8">
            No lorebook retrieval data available yet. Generate a response to see active entries.
          </p>
        {/if}
      </div>
    </div>
  </div>

/app/src/lib/components/story/Suggestions.svelte:68:11
Warn: `<button>` cannot be a descendant of `<button>`. When rendering this component on the server, the resulting HTML will be modified by the browser (by moving, removing, or inserting elements), likely resulting in a `hydration_mismatch` warning
https://svelte.dev/e/node_invalid_placement_ssr (svelte)
        {#if !collapsed}
          <button
            class="btn-ghost p-1.5 rounded text-surface-400 hover:text-surface-200"
            onclick={(e) => { e.stopPropagation(); onRefresh(); }}
            disabled={loading}
            title="Generate new suggestions"
          >
            <RefreshCw class="h-4 w-4 {loading ? 'animate-spin' : ''}" />
          </button>
        {/if}

/app/src/lib/components/wizard/SetupWizard.svelte:942:15
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
            <div class="mt-4">
              <label class="mb-2 block text-sm font-medium text-surface-300">
                Describe your genre
              </label>
              <input

/app/src/lib/components/wizard/SetupWizard.svelte:962:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Setting Seed
            </label>
            <textarea

/app/src/lib/components/wizard/SetupWizard.svelte:1082:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div>
                    <label class="mb-1 block text-xs font-medium text-surface-400">Character Name</label>
                    <input

/app/src/lib/components/wizard/SetupWizard.svelte:1092:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div>
                    <label class="mb-1 block text-xs font-medium text-surface-400">Description</label>
                    <textarea

/app/src/lib/components/wizard/SetupWizard.svelte:1102:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div>
                    <label class="mb-1 block text-xs font-medium text-surface-400">Background</label>
                    <textarea

/app/src/lib/components/wizard/SetupWizard.svelte:1112:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div>
                    <label class="mb-1 block text-xs font-medium text-surface-400">Motivation</label>
                    <input

/app/src/lib/components/wizard/SetupWizard.svelte:1122:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div>
                    <label class="mb-1 block text-xs font-medium text-surface-400">Traits (comma-separated)</label>
                    <input

/app/src/lib/components/wizard/SetupWizard.svelte:1286:25
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">Name</label>
                        <input

/app/src/lib/components/wizard/SetupWizard.svelte:1295:25
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">Role</label>
                        <input

/app/src/lib/components/wizard/SetupWizard.svelte:1306:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Description</label>
                      <textarea

/app/src/lib/components/wizard/SetupWizard.svelte:1316:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Relationship to Protagonist</label>
                      <input

/app/src/lib/components/wizard/SetupWizard.svelte:1326:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Traits (comma-separated)</label>
                      <input

/app/src/lib/components/wizard/SetupWizard.svelte:1428:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">Point of View</label>
            <div class="grid gap-2 {selectedMode === 'creative-writing' ? 'grid-cols-1' : 'grid-cols-2'}">

/app/src/lib/components/wizard/SetupWizard.svelte:1446:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">Tense</label>
            <div class="grid grid-cols-2 gap-2">

/app/src/lib/components/wizard/SetupWizard.svelte:1464:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">Tone</label>
            <div class="flex flex-wrap gap-2 mb-2">

/app/src/lib/components/wizard/SetupWizard.svelte:1497:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">Story Title</label>
            <input

/app/src/lib/components/wizard/SetupWizard.svelte:108:7
Warn: `importFileInput` is updated, but is not declared with `$state(...)`. Changing its value will not correctly trigger updates
https://svelte.dev/e/non_reactive_update (svelte)
  let importError = $state<string | null>(null);
  let importFileInput: HTMLInputElement | null = null;

/app/src/lib/components/story/LibraryView.svelte:360:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Story Mode
            </label>
            <div class="grid grid-cols-2 gap-3">

/app/src/lib/components/story/LibraryView.svelte:401:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Point of View
            </label>
            {#if selectedMode === 'creative-writing'}

/app/src/lib/components/story/LibraryView.svelte:437:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Story Title
            </label>
            <input

/app/src/lib/components/story/LibraryView.svelte:451:15
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
            <div class="mt-4">
              <label class="mb-2 block text-sm font-medium text-surface-300">
                Opening Scene Preview
              </label>
              <div class="rounded-lg bg-surface-900 p-4 text-sm text-surface-400 max-h-32 overflow-y-auto">

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:15:21
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  // Form state
  let name = $state(entry?.name ?? '');
  let type = $state<EntryType>(entry?.type ?? 'character');

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:16:32
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let name = $state(entry?.name ?? '');
  let type = $state<EntryType>(entry?.type ?? 'character');
  let description = $state(entry?.description ?? '');

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:17:28
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let type = $state<EntryType>(entry?.type ?? 'character');
  let description = $state(entry?.description ?? '');
  let hiddenInfo = $state(entry?.hiddenInfo ?? '');

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:18:27
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let description = $state(entry?.description ?? '');
  let hiddenInfo = $state(entry?.hiddenInfo ?? '');
  let aliases = $state<string[]>(entry?.aliases ?? []);

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:19:34
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let hiddenInfo = $state(entry?.hiddenInfo ?? '');
  let aliases = $state<string[]>(entry?.aliases ?? []);
  let keywords = $state<string[]>(entry?.injection.keywords ?? []);

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:20:35
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let aliases = $state<string[]>(entry?.aliases ?? []);
  let keywords = $state<string[]>(entry?.injection.keywords ?? []);
  let injectionMode = $state<EntryInjectionMode>(entry?.injection.mode ?? 'keyword');

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:21:50
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let keywords = $state<string[]>(entry?.injection.keywords ?? []);
  let injectionMode = $state<EntryInjectionMode>(entry?.injection.mode ?? 'keyword');
  let priority = $state(entry?.injection.priority ?? 50);

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:22:25
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let injectionMode = $state<EntryInjectionMode>(entry?.injection.mode ?? 'keyword');
  let priority = $state(entry?.injection.priority ?? 50);
  let showHiddenInfo = $state(!!entry?.hiddenInfo);

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:23:33
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let priority = $state(entry?.injection.priority ?? 50);
  let showHiddenInfo = $state(!!entry?.hiddenInfo);
  let loreManagementBlacklisted = $state(entry?.loreManagementBlacklisted ?? false);

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:24:42
Warn: This reference only captures the initial value of `entry`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let showHiddenInfo = $state(!!entry?.hiddenInfo);
  let loreManagementBlacklisted = $state(entry?.loreManagementBlacklisted ?? false);

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:202:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">
      Name <span class="text-red-400">*</span>
    </label>
    <input

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:215:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">Type</label>
    <select bind:value={type} class="input w-full">

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:225:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">Description</label>
    <textarea

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:236:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">
      Aliases
      <span class="text-xs text-surface-500 font-normal ml-1">
        Alternative names for matching
      </span>
    </label>
    <div class="flex flex-wrap gap-2 mb-2">

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:275:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">
      Keywords
      <span class="text-xs text-surface-500 font-normal ml-1">
        Trigger words for injection
      </span>
    </label>
    <div class="flex flex-wrap gap-2 mb-2">

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:314:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">Context Inclusion</label>
    <div class="grid grid-cols-3 gap-2">

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:338:5
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
  <div>
    <label class="block text-sm font-medium text-surface-300 mb-1">
      Priority
      <span class="text-xs text-surface-500 font-normal ml-1">
        Higher priority entries are injected first
      </span>
    </label>
    <div class="flex items-center gap-3">

/app/src/lib/components/lorebook/LorebookEntryForm.svelte:364:5
Warn: Buttons and links should either contain text or have an `aria-label`, `aria-labelledby` or `title` attribute
https://svelte.dev/e/a11y_consider_explicit_label (svelte)
    </div>
    <button
      type="button"
      class="relative w-11 h-6 rounded-full transition-colors
        {loreManagementBlacklisted ? 'bg-amber-500' : 'bg-surface-600'}"
      onclick={() => loreManagementBlacklisted = !loreManagementBlacklisted}
    >
      <span
        class="absolute top-1 left-1 w-4 h-4 rounded-full bg-white transition-transform
          {loreManagementBlacklisted ? 'translate-x-5' : ''}"
      ></span>
    </button>
  </div>

/app/src/lib/components/lorebook/LorebookImportModal.svelte:187:3
Warn: Non-interactive element `<div>` should not be assigned mouse or keyboard event listeners
https://svelte.dev/e/a11y_no_noninteractive_element_interactions (svelte)
>
  <div
    class="card w-full max-w-lg max-h-[90vh] overflow-hidden rounded-b-none sm:rounded-b-xl"
    onclick={(e) => e.stopPropagation()}
    onkeydown={(e) => e.stopPropagation()}
    role="document"
    use:swipe={{ onSwipeDown: handleSwipeDown, threshold: 50 }}
  >
    <!-- Mobile swipe handle indicator -->
    <div class="sm:hidden flex justify-center pt-2 pb-1">
      <div class="w-10 h-1 rounded-full bg-surface-600"></div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between border-b border-surface-700 pb-4 pt-0 sm:pt-0">
      <div class="flex items-center gap-2">
        <Upload class="h-5 w-5 text-accent-400" />
        <h2 class="text-xl font-semibold text-surface-100">Import Lorebook</h2>
      </div>
      <button class="btn-ghost rounded-lg p-2" onclick={close}>
        <X class="h-5 w-5" />
      </button>
    </div>

    <!-- Content -->
    <div class="py-4 space-y-4 max-h-[60vh] overflow-y-auto">
      {#if error}
        <div class="p-3 rounded-lg bg-red-500/20 border border-red-500/50 flex items-start gap-2">
          <AlertCircle class="h-5 w-5 text-red-400 flex-shrink-0 mt-0.5" />
          <p class="text-red-300 text-sm">{error}</p>
        </div>
      {/if}

      {#if !parseResult}
        <!-- File upload area -->
        <div
          class="border-2 border-dashed rounded-lg p-8 text-center transition-colors
            {dragOver ? 'border-accent-500 bg-accent-500/10' : 'border-surface-600 hover:border-surface-500'}"
          ondrop={handleDrop}
          ondragover={handleDragOver}
          ondragleave={handleDragLeave}
          role="button"
          tabindex="0"
          onclick={() => fileInput.click()}
          onkeydown={(e) => e.key === 'Enter' && fileInput.click()}
        >
          <FileJson class="h-12 w-12 text-surface-500 mx-auto mb-3" />
          <p class="text-surface-300 mb-1">Drop a lorebook file here</p>
          <p class="text-sm text-surface-500">or click to browse</p>
        </div>
        <input
          type="file"
          accept=".json,.avt,application/json,*/*"
          class="hidden"
          bind:this={fileInput}
          onchange={handleFileSelect}
        />

        <p class="text-xs text-surface-500">
          Supports Aventura (.avt, .json) and SillyTavern lorebook formats
        </p>
      {:else}
        <!-- Preview -->
        <div class="p-4 rounded-lg bg-surface-800/50 border border-surface-700">
          <div class="flex items-center gap-2 mb-3">
            <Check class="h-5 w-5 text-green-400" />
            <span class="text-surface-200">Found {previewCount} entries</span>
          </div>

          <!-- Entry type breakdown -->
          <div class="text-sm text-surface-400 space-y-1">
            {#each Object.entries(typeCounts) as [type, count]}
              <div class="flex items-center justify-between">
                <span class="capitalize">{type}</span>
                <span>{count}</span>
              </div>
            {/each}
          </div>
        </div>

        <!-- AI Classification toggle -->
        <label class="flex items-center justify-between p-3 rounded-lg bg-surface-800/50 border border-surface-700 cursor-pointer">
          <div>
            <div class="text-surface-200">AI-powered classification</div>
            <div class="text-xs text-surface-500">Use AI to better categorize entry types</div>
          </div>
          <input
            type="checkbox"
            bind:checked={useAIClassification}
            class="h-5 w-5 rounded border-surface-600 bg-surface-800 text-accent-500 focus:ring-accent-500"
          />
        </label>

        {#if classifying}
          <div class="p-3 rounded-lg bg-surface-800/50 border border-surface-700">
            <div class="flex items-center gap-2 mb-2">
              <Loader2 class="h-4 w-4 text-accent-400 animate-spin" />
              <span class="text-sm text-surface-300">Classifying entries...</span>
            </div>
            <div class="w-full h-2 bg-surface-700 rounded-full overflow-hidden">
              <div
                class="h-full bg-accent-500 transition-all"
                style="width: {classificationProgress}%"
              ></div>
            </div>
          </div>
        {/if}

        <!-- Change file button -->
        <button
          class="text-sm text-accent-400 hover:text-accent-300"
          onclick={() => { parseResult = null; error = null; }}
        >
          Choose a different file
        </button>
      {/if}
    </div>

    <!-- Footer -->
    <div class="flex gap-2 pt-4 border-t border-surface-700">
      <button
        class="btn-ghost flex-1 py-2 border border-surface-600 rounded-lg"
        onclick={close}
        disabled={importing}
      >
        Cancel
      </button>
      <button
        class="btn-primary flex-1 py-2 flex items-center justify-center gap-2"
        onclick={handleImport}
        disabled={!parseResult || importing || classifying}
      >
        {#if importing || classifying}
          <Loader2 class="h-4 w-4 animate-spin" />
          {classifying ? 'Classifying...' : 'Importing...'}
        {:else}
          Import {previewCount} Entries
        {/if}
      </button>
    </div>
  </div>
</div>

/app/src/lib/components/lorebook/LorebookImportModal.svelte:16:7
Warn: `fileInput` is updated, but is not declared with `$state(...)`. Changing its value will not correctly trigger updates
https://svelte.dev/e/non_reactive_update (svelte)

  let fileInput: HTMLInputElement;
  let dragOver = $state(false);

/app/src/lib/components/lorebook/LorebookExportModal.svelte:68:3
Warn: Non-interactive element `<div>` should not be assigned mouse or keyboard event listeners
https://svelte.dev/e/a11y_no_noninteractive_element_interactions (svelte)
>
  <div
    class="card w-full max-w-md max-h-[90vh] overflow-hidden rounded-b-none sm:rounded-b-xl"
    onclick={(e) => e.stopPropagation()}
    onkeydown={(e) => e.stopPropagation()}
    role="document"
    use:swipe={{ onSwipeDown: handleSwipeDown, threshold: 50 }}
  >
    <!-- Mobile swipe handle indicator -->
    <div class="sm:hidden flex justify-center pt-2 pb-1">
      <div class="w-10 h-1 rounded-full bg-surface-600"></div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between border-b border-surface-700 pb-4 pt-0 sm:pt-0">
      <div class="flex items-center gap-2">
        <Download class="h-5 w-5 text-accent-400" />
        <h2 class="text-xl font-semibold text-surface-100">Export Lorebook</h2>
      </div>
      <button class="btn-ghost rounded-lg p-2" onclick={close}>
        <X class="h-5 w-5" />
      </button>
    </div>

    <!-- Content -->
    <div class="py-4 space-y-4">
      {#if error}
        <div class="p-3 rounded-lg bg-red-500/20 border border-red-500/50 text-red-300 text-sm">
          {error}
        </div>
      {/if}

      <!-- Export scope -->
      {#if hasSelection}
        <div class="space-y-2">
          <label class="text-sm font-medium text-surface-300">What to export</label>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer
              {!exportSelected ? 'border-accent-500 bg-accent-500/20' : 'border-surface-600 bg-surface-800'}">
              <input
                type="radio"
                name="scope"
                checked={!exportSelected}
                onchange={() => exportSelected = false}
                class="h-4 w-4 text-accent-500 focus:ring-accent-500"
              />
              <div>
                <div class="text-surface-200">All entries</div>
                <div class="text-xs text-surface-500">{story.lorebookEntries.length} entries</div>
              </div>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer
              {exportSelected ? 'border-accent-500 bg-accent-500/20' : 'border-surface-600 bg-surface-800'}">
              <input
                type="radio"
                name="scope"
                checked={exportSelected}
                onchange={() => exportSelected = true}
                class="h-4 w-4 text-accent-500 focus:ring-accent-500"
              />
              <div>
                <div class="text-surface-200">Selected only</div>
                <div class="text-xs text-surface-500">{ui.lorebookBulkSelection.size} entries</div>
              </div>
            </label>
          </div>
        </div>
      {:else}
        <div class="p-3 rounded-lg bg-surface-800/50 border border-surface-700">
          <div class="text-surface-200">{story.lorebookEntries.length} entries</div>
          <div class="text-xs text-surface-500">All lorebook entries will be exported</div>
        </div>
      {/if}

      <!-- Format selection -->
      <div class="space-y-2">
        <label class="text-sm font-medium text-surface-300">Export format</label>
        <div class="space-y-2">
          {#each formats as format}
            {@const info = getFormatInfo(format)}
            <button
              class="w-full flex items-start gap-3 p-3 rounded-lg border text-left transition-colors
                {selectedFormat === format
                  ? 'border-accent-500 bg-accent-500/20'
                  : 'border-surface-600 bg-surface-800 hover:bg-surface-700'}"
              onclick={() => selectedFormat = format}
            >
              <div class="flex-shrink-0 mt-0.5">
                {#if selectedFormat === format}
                  <Check class="h-5 w-5 text-accent-400" />
                {:else if format === 'text'}
                  <FileText class="h-5 w-5 text-surface-500" />
                {:else}
                  <FileJson class="h-5 w-5 text-surface-500" />
                {/if}
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium text-surface-200">{info.label}</div>
                <div class="text-xs text-surface-500">{info.description}</div>
              </div>
              <div class="text-xs text-surface-600">{info.extension}</div>
            </button>
          {/each}
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="flex gap-2 pt-4 border-t border-surface-700">
      <button
        class="btn-ghost flex-1 py-2 border border-surface-600 rounded-lg"
        onclick={close}
        disabled={exporting}
      >
        Cancel
      </button>
      <button
        class="btn-primary flex-1 py-2 flex items-center justify-center gap-2"
        onclick={handleExport}
        disabled={exporting || entryCount === 0}
      >
        {#if exporting}
          <Loader2 class="h-4 w-4 animate-spin" />
          Exporting...
        {:else}
          <Download class="h-4 w-4" />
          Export
        {/if}
      </button>
    </div>
  </div>
</div>

/app/src/lib/components/lorebook/LorebookExportModal.svelte:102:11
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
        <div class="space-y-2">
          <label class="text-sm font-medium text-surface-300">What to export</label>
          <div class="space-y-2">

/app/src/lib/components/lorebook/LorebookExportModal.svelte:143:9
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
      <div class="space-y-2">
        <label class="text-sm font-medium text-surface-300">Export format</label>
        <div class="space-y-2">

/app/src/lib/components/memory/MemorySettings.svelte:10:31
Warn: This reference only captures the initial value of `threshold`. Did you mean to reference it inside a closure instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  // Local state for editing
  let localThreshold = $state(threshold);
  let localBuffer = $state(bufferMessages);

/app/src/lib/components/memory/MemorySettings.svelte:11:28
Warn: This reference only captures the initial value of `bufferMessages`. Did you mean to reference it inside a closure instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  let localThreshold = $state(threshold);
  let localBuffer = $state(bufferMessages);

/app/src/lib/components/memory/ChapterCard.svelte:31:30
Warn: This reference only captures the initial value of `chapter`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)

  let editedSummary = $state(chapter.summary);

/app/src/lib/components/memory/ManualChapterModal.svelte:25:42
Warn: This reference only captures the initial value of `entries`. Did you mean to reference it inside a derived instead?
https://svelte.dev/e/state_referenced_locally (svelte)
  // Selected entry index (relative to available entries)
  let selectedIndex = $state(Math.max(0, entries.length - 1));

/app/src/lib/components/memory/ManualChapterModal.svelte:61:1
Warn: Visible, non-interactive elements with a click event must be accompanied by a keyboard event handler. Consider whether an interactive element such as `<button type="button">` or `<a>` might be more appropriate
https://svelte.dev/e/a11y_click_events_have_key_events (svelte)
<!-- Backdrop -->
<div
  class="fixed inset-0 bg-black/60 z-50"
  transition:fade={{ duration: 150 }}
  onclick={onClose}
  role="button"
  tabindex="-1"
></div>

/app/src/lib/components/settings/SettingsModal.svelte:285:1
Warn: Visible, non-interactive elements with a click event must be accompanied by a keyboard event handler. Consider whether an interactive element such as `<button type="button">` or `<a>` might be more appropriate
https://svelte.dev/e/a11y_click_events_have_key_events (svelte)

<div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60" onclick={() => ui.closeSettings()}>
  <div
    class="card w-full sm:max-w-2xl max-h-[95vh] sm:max-h-[80vh] overflow-hidden rounded-b-none sm:rounded-b-xl flex flex-col"
    onclick={(e) => e.stopPropagation()}
    use:swipe={{ onSwipeDown: handleSwipeDown, threshold: 50 }}
  >
    <!-- Mobile swipe handle indicator -->
    <div class="sm:hidden flex justify-center pt-2 pb-1">
      <div class="w-10 h-1 rounded-full bg-surface-600"></div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between border-b border-surface-700 pb-3 sm:pb-4 pt-0 sm:pt-0 flex-shrink-0">
      <h2 class="text-lg sm:text-xl font-semibold text-surface-100">Settings</h2>
      <button class="btn-ghost rounded-lg p-2 min-h-[44px] min-w-[44px] flex items-center justify-center" onclick={() => ui.closeSettings()}>
        <X class="h-5 w-5" />
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-1 border-b border-surface-700 py-2 overflow-x-auto scrollbar-hide flex-shrink-0 -mx-4 px-4 sm:mx-0 sm:px-0">
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'api'}
        class:text-surface-100={activeTab === 'api'}
        class:text-surface-400={activeTab !== 'api'}
        onclick={() => activeTab = 'api'}
      >
        <Key class="h-4 w-4" />
        <span>API</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'generation'}
        class:text-surface-100={activeTab === 'generation'}
        class:text-surface-400={activeTab !== 'generation'}
        onclick={() => activeTab = 'generation'}
      >
        <Cpu class="h-4 w-4" />
        <span class="hidden xs:inline">Generation</span>
        <span class="xs:hidden">Gen</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'ui'}
        class:text-surface-100={activeTab === 'ui'}
        class:text-surface-400={activeTab !== 'ui'}
        onclick={() => activeTab = 'ui'}
      >
        <Palette class="h-4 w-4" />
        <span class="hidden xs:inline">Interface</span>
        <span class="xs:hidden">UI</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'advanced'}
        class:text-surface-100={activeTab === 'advanced'}
        class:text-surface-400={activeTab !== 'advanced'}
        onclick={() => activeTab = 'advanced'}
      >
        <Settings2 class="h-4 w-4" />
        <span class="hidden xs:inline">Advanced</span>
        <span class="xs:hidden">Adv</span>
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto py-4 min-h-0">
      {#if activeTab === 'api'}
        <div class="space-y-4">
          <!-- Provider Selection -->
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              AI Provider
            </label>
            <div class="flex gap-2">
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'openrouter'}
                class:border-accent-500={settings.apiSettings.provider === 'openrouter'}
                class:text-white={settings.apiSettings.provider === 'openrouter'}
                class:bg-surface-700={settings.apiSettings.provider !== 'openrouter'}
                class:border-surface-600={settings.apiSettings.provider !== 'openrouter'}
                class:text-surface-300={settings.apiSettings.provider !== 'openrouter'}
                onclick={async () => {
                  await settings.setProvider('openrouter');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">OpenRouter</div>
                <div class="text-xs opacity-75 mt-0.5">Aggregator (Many models)</div>
              </button>
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'nanogpt'}
                class:border-accent-500={settings.apiSettings.provider === 'nanogpt'}
                class:text-white={settings.apiSettings.provider === 'nanogpt'}
                class:bg-surface-700={settings.apiSettings.provider !== 'nanogpt'}
                class:border-surface-600={settings.apiSettings.provider !== 'nanogpt'}
                class:text-surface-300={settings.apiSettings.provider !== 'nanogpt'}
                onclick={async () => {
                  await settings.setProvider('nanogpt');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">NanoGPT</div>
                <div class="text-xs opacity-75 mt-0.5">Pay-per-prompt</div>
              </button>
            </div>
          </div>

          {#if settings.apiSettings.provider === 'openrouter'}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                OpenRouter API Key
              </label>
              {#if apiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearOpenRouterApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={apiKeyInput}
                    placeholder="sk-or-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveOpenRouterApiKey}
                    disabled={!apiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://openrouter.ai/keys" target="_blank" class="text-accent-400 hover:underline">openrouter.ai</a>
              </p>
            </div>
          {:else}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                NanoGPT API Key
              </label>
              {#if nanogptApiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearNanoGPTApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={nanogptApiKeyInput}
                    placeholder="nano-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveNanoGPTApiKey}
                    disabled={!nanogptApiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://nano-gpt.com" target="_blank" class="text-accent-400 hover:underline">nano-gpt.com</a>
              </p>
            </div>
          {/if}

          <div>
            <div class="mb-2 flex items-center justify-between">
              <label class="text-sm font-medium text-surface-300">
                Default Model
              </label>
              <button
                class="flex items-center gap-1 text-xs text-accent-400 hover:text-accent-300 disabled:opacity-50"
                onclick={handleRefreshModels}
                disabled={isLoadingModels}
              >
                <span class={isLoadingModels ? 'animate-spin' : ''}>
                  <RefreshCw class="h-3 w-3" />
                </span>
                Refresh
              </button>
            </div>

            {#if modelError}
              <p class="mb-2 text-xs text-amber-400">{modelError}</p>
            {/if}

            <!-- Search input -->
            <div class="relative mb-2">
              <Search class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-surface-500" />
              <input
                type="text"
                bind:value={modelSearch}
                placeholder="Search models..."
                class="input pl-9 text-sm"
              />
            </div>

            <!-- Model select -->
            <select
              class="input"
              value={settings.apiSettings.defaultModel}
              onchange={(e) => settings.setDefaultModel(e.currentTarget.value)}
              disabled={isLoadingModels}
            >
              {#if isLoadingModels}
                <option>Loading models...</option>
              {:else}
                {#each filteredModels as model}
                  <option value={model.id}>
                    {model.name} ({formatContextLength(model.contextLength)} ctx)
                  </option>
                {/each}
              {/if}
            </select>

            {#if models.length > 0}
              <p class="mt-1 text-xs text-surface-500">
                {models.length} models available
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'generation'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Temperature: {settings.apiSettings.temperature.toFixed(1)}
            </label>
            <input
              type="range"
              min="0"
              max="2"
              step="0.1"
              value={settings.apiSettings.temperature}
              oninput={(e) => settings.setTemperature(parseFloat(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Focused</span>
              <span>Creative</span>
            </div>
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Max Tokens: {settings.apiSettings.maxTokens}
            </label>
            <input
              type="range"
              min="256"
              max="4096"
              step="128"
              value={settings.apiSettings.maxTokens}
              oninput={(e) => settings.setMaxTokens(parseInt(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Shorter</span>
              <span>Longer</span>
            </div>
          </div>

          <!-- Extended Thinking Toggle -->
          <div class="border-t border-surface-700 pt-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <Sparkles class="h-5 w-5 text-amber-400" />
                <div>
                  <label class="text-sm font-medium text-surface-300">Extended Thinking</label>
                  <p class="text-xs text-surface-500">
                    Enable reasoning for supported models (e.g., GLM 4.7, DeepSeek v3.2)
                  </p>
                </div>
              </div>
              <button
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                class:bg-accent-600={settings.apiSettings.enableThinking}
                class:bg-surface-600={!settings.apiSettings.enableThinking}
                onclick={() => settings.setEnableThinking(!settings.apiSettings.enableThinking)}
                aria-label="Toggle extended thinking"
              >
                <span
                  class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                  class:translate-x-6={settings.apiSettings.enableThinking}
                  class:translate-x-1={!settings.apiSettings.enableThinking}
                ></span>
              </button>
            </div>
            {#if settings.apiSettings.enableThinking}
              <p class="mt-2 text-xs text-amber-400/80 ml-8">
                The model will use internal reasoning to improve responses. Reasoning is not shown or stored.
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'ui'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Theme
            </label>
            <select
              class="input"
              value={settings.uiSettings.theme}
              onchange={(e) => settings.setTheme(e.currentTarget.value as ThemeId)}
            >
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="retro-console">Retro Console</option>
            </select>
            {#if settings.uiSettings.theme === 'retro-console'}
              <p class="mt-1 text-xs text-surface-400">
                CRT aesthetic inspired by PS2-era games and Serial Experiments Lain
              </p>
            {/if}
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Font Size
            </label>
            <select
              class="input"
              value={settings.uiSettings.fontSize}
              onchange={(e) => settings.setFontSize(e.currentTarget.value as 'small' | 'medium' | 'large')}
            >
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-surface-300">Show Word Count</label>
            <input
              type="checkbox"
              checked={settings.uiSettings.showWordCount}
              onchange={() => {
                settings.uiSettings.showWordCount = !settings.uiSettings.showWordCount;
              }}
              class="h-5 w-5 rounded border-surface-600 bg-surface-700"
            />
          </div>

          <div class="flex items-center justify-between">
            <div>
              <label class="text-sm font-medium text-surface-300">Spellcheck</label>
              <p class="text-xs text-surface-500">Grammar and spelling suggestions while typing</p>
            </div>
            <button
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
              class:bg-accent-600={settings.uiSettings.spellcheckEnabled}
              class:bg-surface-600={!settings.uiSettings.spellcheckEnabled}
              onclick={() => settings.setSpellcheckEnabled(!settings.uiSettings.spellcheckEnabled)}
              aria-label="Toggle spellcheck"
            >
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                class:translate-x-6={settings.uiSettings.spellcheckEnabled}
                class:translate-x-1={!settings.uiSettings.spellcheckEnabled}
              ></span>
            </button>
          </div>

          <!-- Updates Section -->
          <div class="border-t border-surface-700 pt-4 mt-4">
            <div class="flex items-center gap-2 mb-3">
              <Download class="h-5 w-5 text-accent-400" />
              <h3 class="text-sm font-medium text-surface-200">Updates</h3>
            </div>

            <!-- Update Status -->
            <div class="card bg-surface-900 p-3 mb-3">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <p class="text-sm text-surface-200">
                    {#if updateInfo?.available}
                      Update available: v{updateInfo.version}
                    {:else if updateInfo !== null}
                      You're up to date
                    {:else}
                      Check for updates
                    {/if}
                  </p>
                  <p class="text-xs text-surface-500">
                    Last checked: {formatLastChecked(settings.updateSettings.lastChecked)}
                  </p>
                </div>
                <button
                  class="btn btn-secondary text-sm flex items-center gap-2"
                  onclick={handleCheckForUpdates}
                  disabled={isCheckingUpdates || isDownloadingUpdate}
                >
                  {#if isCheckingUpdates}
                    <Loader2 class="h-4 w-4 animate-spin" />
                    Checking...
                  {:else}
                    <RefreshCw class="h-4 w-4" />
                    Check
                  {/if}
                </button>
              </div>

              {#if updateError}
                <p class="text-xs text-red-400 mt-2">{updateError}</p>
              {/if}

              {#if updateInfo?.available}
                <div class="mt-3 pt-3 border-t border-surface-700">
                  {#if updateInfo.body}
                    <p class="text-xs text-surface-400 mb-3 line-clamp-3">{updateInfo.body}</p>
                  {/if}

                  {#if isDownloadingUpdate && downloadProgress}
                    <div class="mb-2">
                      <div class="flex justify-between text-xs text-surface-400 mb-1">
                        <span>Downloading...</span>
                        <span>
                          {#if downloadProgress.total}
                            {Math.round((downloadProgress.downloaded / downloadProgress.total) * 100)}%
                          {:else}
                            {Math.round(downloadProgress.downloaded / 1024 / 1024)}MB
                          {/if}
                        </span>
                      </div>
                      <div class="h-2 bg-surface-700 rounded-full overflow-hidden">
                        <div
                          class="h-full bg-accent-500 transition-all duration-300"
                          style="width: {downloadProgress.total ? (downloadProgress.downloaded / downloadProgress.total) * 100 : 50}%"
                        ></div>
                      </div>
                    </div>
                  {:else}
                    <button
                      class="btn btn-primary text-sm w-full flex items-center justify-center gap-2"
                      onclick={handleDownloadAndInstall}
                      disabled={isDownloadingUpdate}
                    >
                      <Download class="h-4 w-4" />
                      Download & Install v{updateInfo.version}
                    </button>
                  {/if}
                </div>
              {/if}
            </div>

            <!-- Auto-update Settings -->
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Check on startup</label>
                  <p class="text-xs text-surface-500">Automatically check for updates when the app opens</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoCheck}
                  class:bg-surface-600={!settings.updateSettings.autoCheck}
                  onclick={() => settings.setAutoCheck(!settings.updateSettings.autoCheck)}
                  aria-label="Toggle auto-check updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoCheck}
                    class:translate-x-1={!settings.updateSettings.autoCheck}
                  ></span>
                </button>
              </div>

              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Auto-download updates</label>
                  <p class="text-xs text-surface-500">Download updates automatically in the background</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoDownload}
                  class:bg-surface-600={!settings.updateSettings.autoDownload}
                  onclick={() => settings.setAutoDownload(!settings.updateSettings.autoDownload)}
                  aria-label="Toggle auto-download updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoDownload}
                    class:translate-x-1={!settings.updateSettings.autoDownload}
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      {:else if activeTab === 'advanced'}
        <div class="space-y-4">
          <!-- Story Generation Section -->
          <div class="border-b border-surface-700 pb-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStoryGenSection = !showStoryGenSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Generation</h3>
                  <p class="text-xs text-surface-500">Main AI prompts for gameplay</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStoryGenerationSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStoryGenSection = !showStoryGenSection}>
                  {#if showStoryGenSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStoryGenSection}
              <div class="mt-3 space-y-3">
                <!-- Adventure Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Adventure Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'adventure' ? null : 'adventure'}
                    >
                      {editingStoryPrompt === 'adventure' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'adventure'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.adventurePrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.adventurePrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>

                <!-- Creative Writing Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Creative Writing Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'creativeWriting' ? null : 'creativeWriting'}
                    >
                      {editingStoryPrompt === 'creativeWriting' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'creativeWriting'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.creativeWritingPrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.creativeWritingPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Wizard Generation Section -->
          <div>
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showWizardSection = !showWizardSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Wizard</h3>
                  <p class="text-xs text-surface-500">Models and prompts for wizard generation</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetAllWizardSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showWizardSection = !showWizardSection}>
                  {#if showWizardSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showWizardSection}
              <div class="mt-3 space-y-3">
                {#each Object.entries(processLabels) as [processKey, label]}
                  {@const process = processKey as keyof AdvancedWizardSettings}
                  {@const processSettings = settings.wizardSettings[process]}
                  <div class="card bg-surface-900 p-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-surface-200">{label}</span>
                      <div class="flex items-center gap-2">
                        <button
                          class="text-xs text-surface-400 hover:text-surface-200"
                          onclick={() => settings.resetWizardProcess(process)}
                          title="Reset to default"
                        >
                          <RotateCcw class="h-3 w-3" />
                        </button>
                        <button
                          class="text-xs text-accent-400 hover:text-accent-300"
                          onclick={() => editingProcess = editingProcess === process ? null : process}
                        >
                          {editingProcess === process ? 'Close' : 'Edit'}
                        </button>
                      </div>
                    </div>

                    {#if editingProcess === process}
                      <div class="space-y-3 pt-2 border-t border-surface-700">
                        <!-- Model Selection -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.wizardSettings[process].model}
                            onblur={() => settings.saveWizardSettings()}
                            placeholder={SCENARIO_MODEL}
                            class="input text-sm"
                          />
                          <p class="text-xs text-surface-500 mt-1">
                            Default: {SCENARIO_MODEL}
                          </p>
                        </div>

                        <!-- Temperature -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {processSettings.temperature?.toFixed(2) ?? 0.8}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="2"
                            step="0.05"
                            bind:value={settings.wizardSettings[process].temperature}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>Focused</span>
                            <span>Creative</span>
                          </div>
                        </div>

                        <!-- Max Tokens -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Max Tokens: {processSettings.maxTokens ?? 1000}
                          </label>
                          <input
                            type="range"
                            min="256"
                            max="4096"
                            step="128"
                            bind:value={settings.wizardSettings[process].maxTokens}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>256</span>
                            <span>4096</span>
                          </div>
                        </div>

                        <!-- System Prompt -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">System Prompt</label>
                          <textarea
                            bind:value={settings.wizardSettings[process].systemPrompt}
                            onblur={() => settings.saveWizardSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono"
                            rows="6"
                          ></textarea>
                          <p class="text-xs text-surface-500 mt-1">
                            {#if process === 'openingGeneration'}
                              Placeholders: {'{userName}'}, {'{genreLabel}'}, {'{mode}'}, {'{tense}'}, {'{tone}'}
                            {:else}
                              Customize the system prompt for this process.
                            {/if}
                          </p>
                        </div>
                      </div>
                    {:else}
                      <div class="text-xs text-surface-400">
                        <span class="text-surface-500">Model:</span> {processSettings.model || SCENARIO_MODEL}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Temp:</span> {processSettings.temperature?.toFixed(1) ?? 0.8}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Tokens:</span> {processSettings.maxTokens ?? 1000}
                      </div>
                    {/if}
                  </div>
                {/each}
              </div>
            {/if}
          </div>

          <!-- Classifier Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showClassifierSection = !showClassifierSection}
              >
                <Brain class="h-4 w-4 text-purple-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">World State Classifier</h3>
                  <p class="text-xs text-surface-500">Extracts entities from narrative responses</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetClassifierSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showClassifierSection = !showClassifierSection}>
                  {#if showClassifierSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showClassifierSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.classifier.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.classifier.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.classifier.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.classifier.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="4000"
                      step="100"
                      bind:value={settings.systemServicesSettings.classifier.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingClassifierPrompt = !editingClassifierPrompt}
                    >
                      {editingClassifierPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingClassifierPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.classifier.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.classifier.systemPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Memory Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showMemorySection = !showMemorySection}
              >
                <BookOpen class="h-4 w-4 text-blue-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Memory & Chapters</h3>
                  <p class="text-xs text-surface-500">Chapter analysis, summarization, and retrieval</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetMemorySettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showMemorySection = !showMemorySection}>
                  {#if showMemorySection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showMemorySection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.memory.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.memory.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.memory.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Chapter Analysis Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Analysis Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterAnalysis' ? null : 'chapterAnalysis'}
                      >
                        {editingMemoryPrompt === 'chapterAnalysis' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterAnalysis'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterAnalysisPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterAnalysisPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Chapter Summarization Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Summarization Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterSummarization' ? null : 'chapterSummarization'}
                      >
                        {editingMemoryPrompt === 'chapterSummarization' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterSummarization'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterSummarizationPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterSummarizationPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Retrieval Decision Prompt -->
                  <div class="border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Retrieval Decision Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'retrievalDecision' ? null : 'retrievalDecision'}
                      >
                        {editingMemoryPrompt === 'retrievalDecision' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'retrievalDecision'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.retrievalDecisionPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.retrievalDecisionPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>
                </div>
              </div>
            {/if}
          </div>

          <!-- Suggestions Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showSuggestionsSection = !showSuggestionsSection}
              >
                <Lightbulb class="h-4 w-4 text-yellow-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Suggestions</h3>
                  <p class="text-xs text-surface-500">Generates story direction suggestions</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetSuggestionsSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showSuggestionsSection = !showSuggestionsSection}>
                  {#if showSuggestionsSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showSuggestionsSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model, Temperature, and Max Tokens Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.suggestions.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.suggestions.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="2"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.suggestions.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.suggestions.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="200"
                      max="2000"
                      step="100"
                      bind:value={settings.systemServicesSettings.suggestions.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingSuggestionsPrompt = !editingSuggestionsPrompt}
                    >
                      {editingSuggestionsPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingSuggestionsPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.suggestions.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[100px] resize-y font-mono w-full"
                      rows="5"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.suggestions.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Style Reviewer Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStyleReviewerSection = !showStyleReviewerSection}
              >
                <Sparkles class="h-4 w-4 text-pink-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Style Reviewer</h3>
                  <p class="text-xs text-surface-500">Analyzes prose for repetitive phrases</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.styleReviewer.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.styleReviewer.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.styleReviewer.enabled =
                      !settings.systemServicesSettings.styleReviewer.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle style reviewer"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.styleReviewer.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.styleReviewer.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStyleReviewerSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStyleReviewerSection = !showStyleReviewerSection}>
                  {#if showStyleReviewerSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStyleReviewerSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.styleReviewer.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="x-ai/grok-4.1-fast"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.styleReviewer.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.styleReviewer.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Trigger Interval -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Review Interval: Every {settings.systemServicesSettings.styleReviewer.triggerInterval} messages
                    </label>
                    <input
                      type="range"
                      min="3"
                      max="15"
                      step="1"
                      bind:value={settings.systemServicesSettings.styleReviewer.triggerInterval}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                    <div class="flex justify-between text-xs text-surface-500">
                      <span>More Frequent</span>
                      <span>Less Frequent</span>
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.styleReviewer.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="3000"
                      step="100"
                      bind:value={settings.systemServicesSettings.styleReviewer.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStyleReviewerPrompt = !editingStyleReviewerPrompt}
                    >
                      {editingStyleReviewerPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStyleReviewerPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.styleReviewer.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[150px] resize-y font-mono w-full"
                      rows="8"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.styleReviewer.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Timeline Fill Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showTimelineFillSection = !showTimelineFillSection}
              >
                <Clock class="h-4 w-4 text-cyan-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Timeline Fill</h3>
                  <p class="text-xs text-surface-500">Retrieves context from past chapters</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.timelineFill.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.timelineFill.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.timelineFill.enabled =
                      !settings.systemServicesSettings.timelineFill.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle timeline fill"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.timelineFill.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.timelineFill.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetTimelineFillSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showTimelineFillSection = !showTimelineFillSection}>
                  {#if showTimelineFillSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showTimelineFillSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <p class="text-xs text-surface-400 mb-3">
                    Timeline Fill retrieves context from past chapters to maintain story consistency.
                    Choose between static (faster, one-shot queries) or agentic (iterative tool-calling) mode.
                  </p>

                  <!-- Mode Selector -->
                  <div class="mb-3">
                    <label class="mb-2 block text-xs font-medium text-surface-400">Retrieval Mode</label>
                    <div class="flex gap-2">
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'static';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Static</div>
                        <div class="text-xs opacity-75 mt-0.5">One-shot queries (default)</div>
                      </button>
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'agentic';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Agentic</div>
                        <div class="text-xs opacity-75 mt-0.5">Iterative tool-calling</div>
                      </button>
                    </div>
                  </div>

                  {#if settings.systemServicesSettings.timelineFill.mode === 'static'}
                    <!-- Static Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <!-- Model and Temperature Row -->
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.timelineFill.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="x-ai/grok-4.1-fast"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.timelineFill.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.timelineFill.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <!-- Max Queries -->
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Queries: {settings.systemServicesSettings.timelineFill.maxQueries}
                        </label>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          step="1"
                          bind:value={settings.systemServicesSettings.timelineFill.maxQueries}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer (faster)</span>
                          <span>More (thorough)</span>
                        </div>
                      </div>

                      <!-- Query Generation Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Generation Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'system' ? null : 'system'}
                          >
                            {editingTimelineFillPrompt === 'system' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'system'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[150px] resize-y font-mono w-full"
                            rows="8"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>

                      <!-- Query Answer Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Answer Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'answer' ? null : 'answer'}
                          >
                            {editingTimelineFillPrompt === 'answer' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'answer'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.queryAnswerPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[100px] resize-y font-mono w-full"
                            rows="5"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.queryAnswerPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {:else}
                    <!-- Agentic Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="minimax/minimax-m2.1"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.agenticRetrieval.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Iterations: {settings.systemServicesSettings.agenticRetrieval.maxIterations}
                        </label>
                        <input
                          type="range"
                          min="3"
                          max="30"
                          step="1"
                          bind:value={settings.systemServicesSettings.agenticRetrieval.maxIterations}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer iterations</span>
                          <span>More thorough</span>
                        </div>
                      </div>

                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Agentic Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingAgenticRetrievalPrompt = !editingAgenticRetrievalPrompt}
                          >
                            {editingAgenticRetrievalPrompt ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingAgenticRetrievalPrompt}
                          <textarea
                            bind:value={settings.systemServicesSettings.agenticRetrieval.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono w-full"
                            rows="6"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.agenticRetrieval.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Reset All Settings -->
          <div class="mt-6 pt-6 border-t border-red-500/30">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-red-400">Reset All Settings</h3>
                <p class="text-xs text-surface-500 mt-1">
                  Reset all settings to their default values. Your API key will be preserved.
                </p>
              </div>
              <button
                class="px-4 py-2 text-sm font-medium text-red-400 border border-red-500/50 rounded-lg hover:bg-red-500/20 transition-colors flex items-center gap-2"
                onclick={handleResetAll}
              >
                <RotateCcw class="h-4 w-4" />
                Reset All
              </button>
            </div>
          </div>
        </div>
      {/if}
    </div>
  </div>
</div>

/app/src/lib/components/settings/SettingsModal.svelte:285:1
Warn: `<div>` with a click handler must have an ARIA role
https://svelte.dev/e/a11y_no_static_element_interactions (svelte)

<div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60" onclick={() => ui.closeSettings()}>
  <div
    class="card w-full sm:max-w-2xl max-h-[95vh] sm:max-h-[80vh] overflow-hidden rounded-b-none sm:rounded-b-xl flex flex-col"
    onclick={(e) => e.stopPropagation()}
    use:swipe={{ onSwipeDown: handleSwipeDown, threshold: 50 }}
  >
    <!-- Mobile swipe handle indicator -->
    <div class="sm:hidden flex justify-center pt-2 pb-1">
      <div class="w-10 h-1 rounded-full bg-surface-600"></div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between border-b border-surface-700 pb-3 sm:pb-4 pt-0 sm:pt-0 flex-shrink-0">
      <h2 class="text-lg sm:text-xl font-semibold text-surface-100">Settings</h2>
      <button class="btn-ghost rounded-lg p-2 min-h-[44px] min-w-[44px] flex items-center justify-center" onclick={() => ui.closeSettings()}>
        <X class="h-5 w-5" />
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-1 border-b border-surface-700 py-2 overflow-x-auto scrollbar-hide flex-shrink-0 -mx-4 px-4 sm:mx-0 sm:px-0">
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'api'}
        class:text-surface-100={activeTab === 'api'}
        class:text-surface-400={activeTab !== 'api'}
        onclick={() => activeTab = 'api'}
      >
        <Key class="h-4 w-4" />
        <span>API</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'generation'}
        class:text-surface-100={activeTab === 'generation'}
        class:text-surface-400={activeTab !== 'generation'}
        onclick={() => activeTab = 'generation'}
      >
        <Cpu class="h-4 w-4" />
        <span class="hidden xs:inline">Generation</span>
        <span class="xs:hidden">Gen</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'ui'}
        class:text-surface-100={activeTab === 'ui'}
        class:text-surface-400={activeTab !== 'ui'}
        onclick={() => activeTab = 'ui'}
      >
        <Palette class="h-4 w-4" />
        <span class="hidden xs:inline">Interface</span>
        <span class="xs:hidden">UI</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'advanced'}
        class:text-surface-100={activeTab === 'advanced'}
        class:text-surface-400={activeTab !== 'advanced'}
        onclick={() => activeTab = 'advanced'}
      >
        <Settings2 class="h-4 w-4" />
        <span class="hidden xs:inline">Advanced</span>
        <span class="xs:hidden">Adv</span>
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto py-4 min-h-0">
      {#if activeTab === 'api'}
        <div class="space-y-4">
          <!-- Provider Selection -->
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              AI Provider
            </label>
            <div class="flex gap-2">
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'openrouter'}
                class:border-accent-500={settings.apiSettings.provider === 'openrouter'}
                class:text-white={settings.apiSettings.provider === 'openrouter'}
                class:bg-surface-700={settings.apiSettings.provider !== 'openrouter'}
                class:border-surface-600={settings.apiSettings.provider !== 'openrouter'}
                class:text-surface-300={settings.apiSettings.provider !== 'openrouter'}
                onclick={async () => {
                  await settings.setProvider('openrouter');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">OpenRouter</div>
                <div class="text-xs opacity-75 mt-0.5">Aggregator (Many models)</div>
              </button>
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'nanogpt'}
                class:border-accent-500={settings.apiSettings.provider === 'nanogpt'}
                class:text-white={settings.apiSettings.provider === 'nanogpt'}
                class:bg-surface-700={settings.apiSettings.provider !== 'nanogpt'}
                class:border-surface-600={settings.apiSettings.provider !== 'nanogpt'}
                class:text-surface-300={settings.apiSettings.provider !== 'nanogpt'}
                onclick={async () => {
                  await settings.setProvider('nanogpt');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">NanoGPT</div>
                <div class="text-xs opacity-75 mt-0.5">Pay-per-prompt</div>
              </button>
            </div>
          </div>

          {#if settings.apiSettings.provider === 'openrouter'}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                OpenRouter API Key
              </label>
              {#if apiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearOpenRouterApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={apiKeyInput}
                    placeholder="sk-or-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveOpenRouterApiKey}
                    disabled={!apiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://openrouter.ai/keys" target="_blank" class="text-accent-400 hover:underline">openrouter.ai</a>
              </p>
            </div>
          {:else}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                NanoGPT API Key
              </label>
              {#if nanogptApiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearNanoGPTApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={nanogptApiKeyInput}
                    placeholder="nano-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveNanoGPTApiKey}
                    disabled={!nanogptApiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://nano-gpt.com" target="_blank" class="text-accent-400 hover:underline">nano-gpt.com</a>
              </p>
            </div>
          {/if}

          <div>
            <div class="mb-2 flex items-center justify-between">
              <label class="text-sm font-medium text-surface-300">
                Default Model
              </label>
              <button
                class="flex items-center gap-1 text-xs text-accent-400 hover:text-accent-300 disabled:opacity-50"
                onclick={handleRefreshModels}
                disabled={isLoadingModels}
              >
                <span class={isLoadingModels ? 'animate-spin' : ''}>
                  <RefreshCw class="h-3 w-3" />
                </span>
                Refresh
              </button>
            </div>

            {#if modelError}
              <p class="mb-2 text-xs text-amber-400">{modelError}</p>
            {/if}

            <!-- Search input -->
            <div class="relative mb-2">
              <Search class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-surface-500" />
              <input
                type="text"
                bind:value={modelSearch}
                placeholder="Search models..."
                class="input pl-9 text-sm"
              />
            </div>

            <!-- Model select -->
            <select
              class="input"
              value={settings.apiSettings.defaultModel}
              onchange={(e) => settings.setDefaultModel(e.currentTarget.value)}
              disabled={isLoadingModels}
            >
              {#if isLoadingModels}
                <option>Loading models...</option>
              {:else}
                {#each filteredModels as model}
                  <option value={model.id}>
                    {model.name} ({formatContextLength(model.contextLength)} ctx)
                  </option>
                {/each}
              {/if}
            </select>

            {#if models.length > 0}
              <p class="mt-1 text-xs text-surface-500">
                {models.length} models available
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'generation'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Temperature: {settings.apiSettings.temperature.toFixed(1)}
            </label>
            <input
              type="range"
              min="0"
              max="2"
              step="0.1"
              value={settings.apiSettings.temperature}
              oninput={(e) => settings.setTemperature(parseFloat(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Focused</span>
              <span>Creative</span>
            </div>
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Max Tokens: {settings.apiSettings.maxTokens}
            </label>
            <input
              type="range"
              min="256"
              max="4096"
              step="128"
              value={settings.apiSettings.maxTokens}
              oninput={(e) => settings.setMaxTokens(parseInt(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Shorter</span>
              <span>Longer</span>
            </div>
          </div>

          <!-- Extended Thinking Toggle -->
          <div class="border-t border-surface-700 pt-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <Sparkles class="h-5 w-5 text-amber-400" />
                <div>
                  <label class="text-sm font-medium text-surface-300">Extended Thinking</label>
                  <p class="text-xs text-surface-500">
                    Enable reasoning for supported models (e.g., GLM 4.7, DeepSeek v3.2)
                  </p>
                </div>
              </div>
              <button
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                class:bg-accent-600={settings.apiSettings.enableThinking}
                class:bg-surface-600={!settings.apiSettings.enableThinking}
                onclick={() => settings.setEnableThinking(!settings.apiSettings.enableThinking)}
                aria-label="Toggle extended thinking"
              >
                <span
                  class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                  class:translate-x-6={settings.apiSettings.enableThinking}
                  class:translate-x-1={!settings.apiSettings.enableThinking}
                ></span>
              </button>
            </div>
            {#if settings.apiSettings.enableThinking}
              <p class="mt-2 text-xs text-amber-400/80 ml-8">
                The model will use internal reasoning to improve responses. Reasoning is not shown or stored.
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'ui'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Theme
            </label>
            <select
              class="input"
              value={settings.uiSettings.theme}
              onchange={(e) => settings.setTheme(e.currentTarget.value as ThemeId)}
            >
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="retro-console">Retro Console</option>
            </select>
            {#if settings.uiSettings.theme === 'retro-console'}
              <p class="mt-1 text-xs text-surface-400">
                CRT aesthetic inspired by PS2-era games and Serial Experiments Lain
              </p>
            {/if}
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Font Size
            </label>
            <select
              class="input"
              value={settings.uiSettings.fontSize}
              onchange={(e) => settings.setFontSize(e.currentTarget.value as 'small' | 'medium' | 'large')}
            >
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-surface-300">Show Word Count</label>
            <input
              type="checkbox"
              checked={settings.uiSettings.showWordCount}
              onchange={() => {
                settings.uiSettings.showWordCount = !settings.uiSettings.showWordCount;
              }}
              class="h-5 w-5 rounded border-surface-600 bg-surface-700"
            />
          </div>

          <div class="flex items-center justify-between">
            <div>
              <label class="text-sm font-medium text-surface-300">Spellcheck</label>
              <p class="text-xs text-surface-500">Grammar and spelling suggestions while typing</p>
            </div>
            <button
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
              class:bg-accent-600={settings.uiSettings.spellcheckEnabled}
              class:bg-surface-600={!settings.uiSettings.spellcheckEnabled}
              onclick={() => settings.setSpellcheckEnabled(!settings.uiSettings.spellcheckEnabled)}
              aria-label="Toggle spellcheck"
            >
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                class:translate-x-6={settings.uiSettings.spellcheckEnabled}
                class:translate-x-1={!settings.uiSettings.spellcheckEnabled}
              ></span>
            </button>
          </div>

          <!-- Updates Section -->
          <div class="border-t border-surface-700 pt-4 mt-4">
            <div class="flex items-center gap-2 mb-3">
              <Download class="h-5 w-5 text-accent-400" />
              <h3 class="text-sm font-medium text-surface-200">Updates</h3>
            </div>

            <!-- Update Status -->
            <div class="card bg-surface-900 p-3 mb-3">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <p class="text-sm text-surface-200">
                    {#if updateInfo?.available}
                      Update available: v{updateInfo.version}
                    {:else if updateInfo !== null}
                      You're up to date
                    {:else}
                      Check for updates
                    {/if}
                  </p>
                  <p class="text-xs text-surface-500">
                    Last checked: {formatLastChecked(settings.updateSettings.lastChecked)}
                  </p>
                </div>
                <button
                  class="btn btn-secondary text-sm flex items-center gap-2"
                  onclick={handleCheckForUpdates}
                  disabled={isCheckingUpdates || isDownloadingUpdate}
                >
                  {#if isCheckingUpdates}
                    <Loader2 class="h-4 w-4 animate-spin" />
                    Checking...
                  {:else}
                    <RefreshCw class="h-4 w-4" />
                    Check
                  {/if}
                </button>
              </div>

              {#if updateError}
                <p class="text-xs text-red-400 mt-2">{updateError}</p>
              {/if}

              {#if updateInfo?.available}
                <div class="mt-3 pt-3 border-t border-surface-700">
                  {#if updateInfo.body}
                    <p class="text-xs text-surface-400 mb-3 line-clamp-3">{updateInfo.body}</p>
                  {/if}

                  {#if isDownloadingUpdate && downloadProgress}
                    <div class="mb-2">
                      <div class="flex justify-between text-xs text-surface-400 mb-1">
                        <span>Downloading...</span>
                        <span>
                          {#if downloadProgress.total}
                            {Math.round((downloadProgress.downloaded / downloadProgress.total) * 100)}%
                          {:else}
                            {Math.round(downloadProgress.downloaded / 1024 / 1024)}MB
                          {/if}
                        </span>
                      </div>
                      <div class="h-2 bg-surface-700 rounded-full overflow-hidden">
                        <div
                          class="h-full bg-accent-500 transition-all duration-300"
                          style="width: {downloadProgress.total ? (downloadProgress.downloaded / downloadProgress.total) * 100 : 50}%"
                        ></div>
                      </div>
                    </div>
                  {:else}
                    <button
                      class="btn btn-primary text-sm w-full flex items-center justify-center gap-2"
                      onclick={handleDownloadAndInstall}
                      disabled={isDownloadingUpdate}
                    >
                      <Download class="h-4 w-4" />
                      Download & Install v{updateInfo.version}
                    </button>
                  {/if}
                </div>
              {/if}
            </div>

            <!-- Auto-update Settings -->
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Check on startup</label>
                  <p class="text-xs text-surface-500">Automatically check for updates when the app opens</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoCheck}
                  class:bg-surface-600={!settings.updateSettings.autoCheck}
                  onclick={() => settings.setAutoCheck(!settings.updateSettings.autoCheck)}
                  aria-label="Toggle auto-check updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoCheck}
                    class:translate-x-1={!settings.updateSettings.autoCheck}
                  ></span>
                </button>
              </div>

              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Auto-download updates</label>
                  <p class="text-xs text-surface-500">Download updates automatically in the background</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoDownload}
                  class:bg-surface-600={!settings.updateSettings.autoDownload}
                  onclick={() => settings.setAutoDownload(!settings.updateSettings.autoDownload)}
                  aria-label="Toggle auto-download updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoDownload}
                    class:translate-x-1={!settings.updateSettings.autoDownload}
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      {:else if activeTab === 'advanced'}
        <div class="space-y-4">
          <!-- Story Generation Section -->
          <div class="border-b border-surface-700 pb-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStoryGenSection = !showStoryGenSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Generation</h3>
                  <p class="text-xs text-surface-500">Main AI prompts for gameplay</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStoryGenerationSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStoryGenSection = !showStoryGenSection}>
                  {#if showStoryGenSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStoryGenSection}
              <div class="mt-3 space-y-3">
                <!-- Adventure Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Adventure Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'adventure' ? null : 'adventure'}
                    >
                      {editingStoryPrompt === 'adventure' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'adventure'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.adventurePrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.adventurePrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>

                <!-- Creative Writing Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Creative Writing Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'creativeWriting' ? null : 'creativeWriting'}
                    >
                      {editingStoryPrompt === 'creativeWriting' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'creativeWriting'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.creativeWritingPrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.creativeWritingPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Wizard Generation Section -->
          <div>
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showWizardSection = !showWizardSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Wizard</h3>
                  <p class="text-xs text-surface-500">Models and prompts for wizard generation</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetAllWizardSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showWizardSection = !showWizardSection}>
                  {#if showWizardSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showWizardSection}
              <div class="mt-3 space-y-3">
                {#each Object.entries(processLabels) as [processKey, label]}
                  {@const process = processKey as keyof AdvancedWizardSettings}
                  {@const processSettings = settings.wizardSettings[process]}
                  <div class="card bg-surface-900 p-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-surface-200">{label}</span>
                      <div class="flex items-center gap-2">
                        <button
                          class="text-xs text-surface-400 hover:text-surface-200"
                          onclick={() => settings.resetWizardProcess(process)}
                          title="Reset to default"
                        >
                          <RotateCcw class="h-3 w-3" />
                        </button>
                        <button
                          class="text-xs text-accent-400 hover:text-accent-300"
                          onclick={() => editingProcess = editingProcess === process ? null : process}
                        >
                          {editingProcess === process ? 'Close' : 'Edit'}
                        </button>
                      </div>
                    </div>

                    {#if editingProcess === process}
                      <div class="space-y-3 pt-2 border-t border-surface-700">
                        <!-- Model Selection -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.wizardSettings[process].model}
                            onblur={() => settings.saveWizardSettings()}
                            placeholder={SCENARIO_MODEL}
                            class="input text-sm"
                          />
                          <p class="text-xs text-surface-500 mt-1">
                            Default: {SCENARIO_MODEL}
                          </p>
                        </div>

                        <!-- Temperature -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {processSettings.temperature?.toFixed(2) ?? 0.8}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="2"
                            step="0.05"
                            bind:value={settings.wizardSettings[process].temperature}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>Focused</span>
                            <span>Creative</span>
                          </div>
                        </div>

                        <!-- Max Tokens -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Max Tokens: {processSettings.maxTokens ?? 1000}
                          </label>
                          <input
                            type="range"
                            min="256"
                            max="4096"
                            step="128"
                            bind:value={settings.wizardSettings[process].maxTokens}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>256</span>
                            <span>4096</span>
                          </div>
                        </div>

                        <!-- System Prompt -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">System Prompt</label>
                          <textarea
                            bind:value={settings.wizardSettings[process].systemPrompt}
                            onblur={() => settings.saveWizardSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono"
                            rows="6"
                          ></textarea>
                          <p class="text-xs text-surface-500 mt-1">
                            {#if process === 'openingGeneration'}
                              Placeholders: {'{userName}'}, {'{genreLabel}'}, {'{mode}'}, {'{tense}'}, {'{tone}'}
                            {:else}
                              Customize the system prompt for this process.
                            {/if}
                          </p>
                        </div>
                      </div>
                    {:else}
                      <div class="text-xs text-surface-400">
                        <span class="text-surface-500">Model:</span> {processSettings.model || SCENARIO_MODEL}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Temp:</span> {processSettings.temperature?.toFixed(1) ?? 0.8}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Tokens:</span> {processSettings.maxTokens ?? 1000}
                      </div>
                    {/if}
                  </div>
                {/each}
              </div>
            {/if}
          </div>

          <!-- Classifier Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showClassifierSection = !showClassifierSection}
              >
                <Brain class="h-4 w-4 text-purple-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">World State Classifier</h3>
                  <p class="text-xs text-surface-500">Extracts entities from narrative responses</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetClassifierSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showClassifierSection = !showClassifierSection}>
                  {#if showClassifierSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showClassifierSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.classifier.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.classifier.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.classifier.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.classifier.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="4000"
                      step="100"
                      bind:value={settings.systemServicesSettings.classifier.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingClassifierPrompt = !editingClassifierPrompt}
                    >
                      {editingClassifierPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingClassifierPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.classifier.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.classifier.systemPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Memory Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showMemorySection = !showMemorySection}
              >
                <BookOpen class="h-4 w-4 text-blue-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Memory & Chapters</h3>
                  <p class="text-xs text-surface-500">Chapter analysis, summarization, and retrieval</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetMemorySettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showMemorySection = !showMemorySection}>
                  {#if showMemorySection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showMemorySection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.memory.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.memory.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.memory.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Chapter Analysis Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Analysis Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterAnalysis' ? null : 'chapterAnalysis'}
                      >
                        {editingMemoryPrompt === 'chapterAnalysis' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterAnalysis'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterAnalysisPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterAnalysisPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Chapter Summarization Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Summarization Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterSummarization' ? null : 'chapterSummarization'}
                      >
                        {editingMemoryPrompt === 'chapterSummarization' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterSummarization'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterSummarizationPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterSummarizationPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Retrieval Decision Prompt -->
                  <div class="border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Retrieval Decision Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'retrievalDecision' ? null : 'retrievalDecision'}
                      >
                        {editingMemoryPrompt === 'retrievalDecision' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'retrievalDecision'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.retrievalDecisionPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.retrievalDecisionPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>
                </div>
              </div>
            {/if}
          </div>

          <!-- Suggestions Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showSuggestionsSection = !showSuggestionsSection}
              >
                <Lightbulb class="h-4 w-4 text-yellow-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Suggestions</h3>
                  <p class="text-xs text-surface-500">Generates story direction suggestions</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetSuggestionsSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showSuggestionsSection = !showSuggestionsSection}>
                  {#if showSuggestionsSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showSuggestionsSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model, Temperature, and Max Tokens Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.suggestions.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.suggestions.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="2"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.suggestions.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.suggestions.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="200"
                      max="2000"
                      step="100"
                      bind:value={settings.systemServicesSettings.suggestions.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingSuggestionsPrompt = !editingSuggestionsPrompt}
                    >
                      {editingSuggestionsPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingSuggestionsPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.suggestions.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[100px] resize-y font-mono w-full"
                      rows="5"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.suggestions.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Style Reviewer Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStyleReviewerSection = !showStyleReviewerSection}
              >
                <Sparkles class="h-4 w-4 text-pink-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Style Reviewer</h3>
                  <p class="text-xs text-surface-500">Analyzes prose for repetitive phrases</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.styleReviewer.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.styleReviewer.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.styleReviewer.enabled =
                      !settings.systemServicesSettings.styleReviewer.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle style reviewer"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.styleReviewer.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.styleReviewer.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStyleReviewerSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStyleReviewerSection = !showStyleReviewerSection}>
                  {#if showStyleReviewerSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStyleReviewerSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.styleReviewer.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="x-ai/grok-4.1-fast"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.styleReviewer.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.styleReviewer.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Trigger Interval -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Review Interval: Every {settings.systemServicesSettings.styleReviewer.triggerInterval} messages
                    </label>
                    <input
                      type="range"
                      min="3"
                      max="15"
                      step="1"
                      bind:value={settings.systemServicesSettings.styleReviewer.triggerInterval}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                    <div class="flex justify-between text-xs text-surface-500">
                      <span>More Frequent</span>
                      <span>Less Frequent</span>
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.styleReviewer.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="3000"
                      step="100"
                      bind:value={settings.systemServicesSettings.styleReviewer.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStyleReviewerPrompt = !editingStyleReviewerPrompt}
                    >
                      {editingStyleReviewerPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStyleReviewerPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.styleReviewer.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[150px] resize-y font-mono w-full"
                      rows="8"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.styleReviewer.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Timeline Fill Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showTimelineFillSection = !showTimelineFillSection}
              >
                <Clock class="h-4 w-4 text-cyan-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Timeline Fill</h3>
                  <p class="text-xs text-surface-500">Retrieves context from past chapters</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.timelineFill.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.timelineFill.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.timelineFill.enabled =
                      !settings.systemServicesSettings.timelineFill.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle timeline fill"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.timelineFill.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.timelineFill.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetTimelineFillSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showTimelineFillSection = !showTimelineFillSection}>
                  {#if showTimelineFillSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showTimelineFillSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <p class="text-xs text-surface-400 mb-3">
                    Timeline Fill retrieves context from past chapters to maintain story consistency.
                    Choose between static (faster, one-shot queries) or agentic (iterative tool-calling) mode.
                  </p>

                  <!-- Mode Selector -->
                  <div class="mb-3">
                    <label class="mb-2 block text-xs font-medium text-surface-400">Retrieval Mode</label>
                    <div class="flex gap-2">
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'static';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Static</div>
                        <div class="text-xs opacity-75 mt-0.5">One-shot queries (default)</div>
                      </button>
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'agentic';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Agentic</div>
                        <div class="text-xs opacity-75 mt-0.5">Iterative tool-calling</div>
                      </button>
                    </div>
                  </div>

                  {#if settings.systemServicesSettings.timelineFill.mode === 'static'}
                    <!-- Static Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <!-- Model and Temperature Row -->
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.timelineFill.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="x-ai/grok-4.1-fast"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.timelineFill.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.timelineFill.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <!-- Max Queries -->
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Queries: {settings.systemServicesSettings.timelineFill.maxQueries}
                        </label>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          step="1"
                          bind:value={settings.systemServicesSettings.timelineFill.maxQueries}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer (faster)</span>
                          <span>More (thorough)</span>
                        </div>
                      </div>

                      <!-- Query Generation Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Generation Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'system' ? null : 'system'}
                          >
                            {editingTimelineFillPrompt === 'system' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'system'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[150px] resize-y font-mono w-full"
                            rows="8"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>

                      <!-- Query Answer Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Answer Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'answer' ? null : 'answer'}
                          >
                            {editingTimelineFillPrompt === 'answer' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'answer'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.queryAnswerPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[100px] resize-y font-mono w-full"
                            rows="5"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.queryAnswerPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {:else}
                    <!-- Agentic Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="minimax/minimax-m2.1"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.agenticRetrieval.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Iterations: {settings.systemServicesSettings.agenticRetrieval.maxIterations}
                        </label>
                        <input
                          type="range"
                          min="3"
                          max="30"
                          step="1"
                          bind:value={settings.systemServicesSettings.agenticRetrieval.maxIterations}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer iterations</span>
                          <span>More thorough</span>
                        </div>
                      </div>

                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Agentic Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingAgenticRetrievalPrompt = !editingAgenticRetrievalPrompt}
                          >
                            {editingAgenticRetrievalPrompt ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingAgenticRetrievalPrompt}
                          <textarea
                            bind:value={settings.systemServicesSettings.agenticRetrieval.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono w-full"
                            rows="6"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.agenticRetrieval.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Reset All Settings -->
          <div class="mt-6 pt-6 border-t border-red-500/30">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-red-400">Reset All Settings</h3>
                <p class="text-xs text-surface-500 mt-1">
                  Reset all settings to their default values. Your API key will be preserved.
                </p>
              </div>
              <button
                class="px-4 py-2 text-sm font-medium text-red-400 border border-red-500/50 rounded-lg hover:bg-red-500/20 transition-colors flex items-center gap-2"
                onclick={handleResetAll}
              >
                <RotateCcw class="h-4 w-4" />
                Reset All
              </button>
            </div>
          </div>
        </div>
      {/if}
    </div>
  </div>
</div>

/app/src/lib/components/settings/SettingsModal.svelte:286:3
Warn: Visible, non-interactive elements with a click event must be accompanied by a keyboard event handler. Consider whether an interactive element such as `<button type="button">` or `<a>` might be more appropriate
https://svelte.dev/e/a11y_click_events_have_key_events (svelte)
<div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60" onclick={() => ui.closeSettings()}>
  <div
    class="card w-full sm:max-w-2xl max-h-[95vh] sm:max-h-[80vh] overflow-hidden rounded-b-none sm:rounded-b-xl flex flex-col"
    onclick={(e) => e.stopPropagation()}
    use:swipe={{ onSwipeDown: handleSwipeDown, threshold: 50 }}
  >
    <!-- Mobile swipe handle indicator -->
    <div class="sm:hidden flex justify-center pt-2 pb-1">
      <div class="w-10 h-1 rounded-full bg-surface-600"></div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between border-b border-surface-700 pb-3 sm:pb-4 pt-0 sm:pt-0 flex-shrink-0">
      <h2 class="text-lg sm:text-xl font-semibold text-surface-100">Settings</h2>
      <button class="btn-ghost rounded-lg p-2 min-h-[44px] min-w-[44px] flex items-center justify-center" onclick={() => ui.closeSettings()}>
        <X class="h-5 w-5" />
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-1 border-b border-surface-700 py-2 overflow-x-auto scrollbar-hide flex-shrink-0 -mx-4 px-4 sm:mx-0 sm:px-0">
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'api'}
        class:text-surface-100={activeTab === 'api'}
        class:text-surface-400={activeTab !== 'api'}
        onclick={() => activeTab = 'api'}
      >
        <Key class="h-4 w-4" />
        <span>API</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'generation'}
        class:text-surface-100={activeTab === 'generation'}
        class:text-surface-400={activeTab !== 'generation'}
        onclick={() => activeTab = 'generation'}
      >
        <Cpu class="h-4 w-4" />
        <span class="hidden xs:inline">Generation</span>
        <span class="xs:hidden">Gen</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'ui'}
        class:text-surface-100={activeTab === 'ui'}
        class:text-surface-400={activeTab !== 'ui'}
        onclick={() => activeTab = 'ui'}
      >
        <Palette class="h-4 w-4" />
        <span class="hidden xs:inline">Interface</span>
        <span class="xs:hidden">UI</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'advanced'}
        class:text-surface-100={activeTab === 'advanced'}
        class:text-surface-400={activeTab !== 'advanced'}
        onclick={() => activeTab = 'advanced'}
      >
        <Settings2 class="h-4 w-4" />
        <span class="hidden xs:inline">Advanced</span>
        <span class="xs:hidden">Adv</span>
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto py-4 min-h-0">
      {#if activeTab === 'api'}
        <div class="space-y-4">
          <!-- Provider Selection -->
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              AI Provider
            </label>
            <div class="flex gap-2">
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'openrouter'}
                class:border-accent-500={settings.apiSettings.provider === 'openrouter'}
                class:text-white={settings.apiSettings.provider === 'openrouter'}
                class:bg-surface-700={settings.apiSettings.provider !== 'openrouter'}
                class:border-surface-600={settings.apiSettings.provider !== 'openrouter'}
                class:text-surface-300={settings.apiSettings.provider !== 'openrouter'}
                onclick={async () => {
                  await settings.setProvider('openrouter');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">OpenRouter</div>
                <div class="text-xs opacity-75 mt-0.5">Aggregator (Many models)</div>
              </button>
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'nanogpt'}
                class:border-accent-500={settings.apiSettings.provider === 'nanogpt'}
                class:text-white={settings.apiSettings.provider === 'nanogpt'}
                class:bg-surface-700={settings.apiSettings.provider !== 'nanogpt'}
                class:border-surface-600={settings.apiSettings.provider !== 'nanogpt'}
                class:text-surface-300={settings.apiSettings.provider !== 'nanogpt'}
                onclick={async () => {
                  await settings.setProvider('nanogpt');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">NanoGPT</div>
                <div class="text-xs opacity-75 mt-0.5">Pay-per-prompt</div>
              </button>
            </div>
          </div>

          {#if settings.apiSettings.provider === 'openrouter'}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                OpenRouter API Key
              </label>
              {#if apiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearOpenRouterApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={apiKeyInput}
                    placeholder="sk-or-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveOpenRouterApiKey}
                    disabled={!apiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://openrouter.ai/keys" target="_blank" class="text-accent-400 hover:underline">openrouter.ai</a>
              </p>
            </div>
          {:else}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                NanoGPT API Key
              </label>
              {#if nanogptApiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearNanoGPTApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={nanogptApiKeyInput}
                    placeholder="nano-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveNanoGPTApiKey}
                    disabled={!nanogptApiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://nano-gpt.com" target="_blank" class="text-accent-400 hover:underline">nano-gpt.com</a>
              </p>
            </div>
          {/if}

          <div>
            <div class="mb-2 flex items-center justify-between">
              <label class="text-sm font-medium text-surface-300">
                Default Model
              </label>
              <button
                class="flex items-center gap-1 text-xs text-accent-400 hover:text-accent-300 disabled:opacity-50"
                onclick={handleRefreshModels}
                disabled={isLoadingModels}
              >
                <span class={isLoadingModels ? 'animate-spin' : ''}>
                  <RefreshCw class="h-3 w-3" />
                </span>
                Refresh
              </button>
            </div>

            {#if modelError}
              <p class="mb-2 text-xs text-amber-400">{modelError}</p>
            {/if}

            <!-- Search input -->
            <div class="relative mb-2">
              <Search class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-surface-500" />
              <input
                type="text"
                bind:value={modelSearch}
                placeholder="Search models..."
                class="input pl-9 text-sm"
              />
            </div>

            <!-- Model select -->
            <select
              class="input"
              value={settings.apiSettings.defaultModel}
              onchange={(e) => settings.setDefaultModel(e.currentTarget.value)}
              disabled={isLoadingModels}
            >
              {#if isLoadingModels}
                <option>Loading models...</option>
              {:else}
                {#each filteredModels as model}
                  <option value={model.id}>
                    {model.name} ({formatContextLength(model.contextLength)} ctx)
                  </option>
                {/each}
              {/if}
            </select>

            {#if models.length > 0}
              <p class="mt-1 text-xs text-surface-500">
                {models.length} models available
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'generation'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Temperature: {settings.apiSettings.temperature.toFixed(1)}
            </label>
            <input
              type="range"
              min="0"
              max="2"
              step="0.1"
              value={settings.apiSettings.temperature}
              oninput={(e) => settings.setTemperature(parseFloat(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Focused</span>
              <span>Creative</span>
            </div>
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Max Tokens: {settings.apiSettings.maxTokens}
            </label>
            <input
              type="range"
              min="256"
              max="4096"
              step="128"
              value={settings.apiSettings.maxTokens}
              oninput={(e) => settings.setMaxTokens(parseInt(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Shorter</span>
              <span>Longer</span>
            </div>
          </div>

          <!-- Extended Thinking Toggle -->
          <div class="border-t border-surface-700 pt-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <Sparkles class="h-5 w-5 text-amber-400" />
                <div>
                  <label class="text-sm font-medium text-surface-300">Extended Thinking</label>
                  <p class="text-xs text-surface-500">
                    Enable reasoning for supported models (e.g., GLM 4.7, DeepSeek v3.2)
                  </p>
                </div>
              </div>
              <button
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                class:bg-accent-600={settings.apiSettings.enableThinking}
                class:bg-surface-600={!settings.apiSettings.enableThinking}
                onclick={() => settings.setEnableThinking(!settings.apiSettings.enableThinking)}
                aria-label="Toggle extended thinking"
              >
                <span
                  class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                  class:translate-x-6={settings.apiSettings.enableThinking}
                  class:translate-x-1={!settings.apiSettings.enableThinking}
                ></span>
              </button>
            </div>
            {#if settings.apiSettings.enableThinking}
              <p class="mt-2 text-xs text-amber-400/80 ml-8">
                The model will use internal reasoning to improve responses. Reasoning is not shown or stored.
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'ui'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Theme
            </label>
            <select
              class="input"
              value={settings.uiSettings.theme}
              onchange={(e) => settings.setTheme(e.currentTarget.value as ThemeId)}
            >
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="retro-console">Retro Console</option>
            </select>
            {#if settings.uiSettings.theme === 'retro-console'}
              <p class="mt-1 text-xs text-surface-400">
                CRT aesthetic inspired by PS2-era games and Serial Experiments Lain
              </p>
            {/if}
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Font Size
            </label>
            <select
              class="input"
              value={settings.uiSettings.fontSize}
              onchange={(e) => settings.setFontSize(e.currentTarget.value as 'small' | 'medium' | 'large')}
            >
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-surface-300">Show Word Count</label>
            <input
              type="checkbox"
              checked={settings.uiSettings.showWordCount}
              onchange={() => {
                settings.uiSettings.showWordCount = !settings.uiSettings.showWordCount;
              }}
              class="h-5 w-5 rounded border-surface-600 bg-surface-700"
            />
          </div>

          <div class="flex items-center justify-between">
            <div>
              <label class="text-sm font-medium text-surface-300">Spellcheck</label>
              <p class="text-xs text-surface-500">Grammar and spelling suggestions while typing</p>
            </div>
            <button
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
              class:bg-accent-600={settings.uiSettings.spellcheckEnabled}
              class:bg-surface-600={!settings.uiSettings.spellcheckEnabled}
              onclick={() => settings.setSpellcheckEnabled(!settings.uiSettings.spellcheckEnabled)}
              aria-label="Toggle spellcheck"
            >
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                class:translate-x-6={settings.uiSettings.spellcheckEnabled}
                class:translate-x-1={!settings.uiSettings.spellcheckEnabled}
              ></span>
            </button>
          </div>

          <!-- Updates Section -->
          <div class="border-t border-surface-700 pt-4 mt-4">
            <div class="flex items-center gap-2 mb-3">
              <Download class="h-5 w-5 text-accent-400" />
              <h3 class="text-sm font-medium text-surface-200">Updates</h3>
            </div>

            <!-- Update Status -->
            <div class="card bg-surface-900 p-3 mb-3">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <p class="text-sm text-surface-200">
                    {#if updateInfo?.available}
                      Update available: v{updateInfo.version}
                    {:else if updateInfo !== null}
                      You're up to date
                    {:else}
                      Check for updates
                    {/if}
                  </p>
                  <p class="text-xs text-surface-500">
                    Last checked: {formatLastChecked(settings.updateSettings.lastChecked)}
                  </p>
                </div>
                <button
                  class="btn btn-secondary text-sm flex items-center gap-2"
                  onclick={handleCheckForUpdates}
                  disabled={isCheckingUpdates || isDownloadingUpdate}
                >
                  {#if isCheckingUpdates}
                    <Loader2 class="h-4 w-4 animate-spin" />
                    Checking...
                  {:else}
                    <RefreshCw class="h-4 w-4" />
                    Check
                  {/if}
                </button>
              </div>

              {#if updateError}
                <p class="text-xs text-red-400 mt-2">{updateError}</p>
              {/if}

              {#if updateInfo?.available}
                <div class="mt-3 pt-3 border-t border-surface-700">
                  {#if updateInfo.body}
                    <p class="text-xs text-surface-400 mb-3 line-clamp-3">{updateInfo.body}</p>
                  {/if}

                  {#if isDownloadingUpdate && downloadProgress}
                    <div class="mb-2">
                      <div class="flex justify-between text-xs text-surface-400 mb-1">
                        <span>Downloading...</span>
                        <span>
                          {#if downloadProgress.total}
                            {Math.round((downloadProgress.downloaded / downloadProgress.total) * 100)}%
                          {:else}
                            {Math.round(downloadProgress.downloaded / 1024 / 1024)}MB
                          {/if}
                        </span>
                      </div>
                      <div class="h-2 bg-surface-700 rounded-full overflow-hidden">
                        <div
                          class="h-full bg-accent-500 transition-all duration-300"
                          style="width: {downloadProgress.total ? (downloadProgress.downloaded / downloadProgress.total) * 100 : 50}%"
                        ></div>
                      </div>
                    </div>
                  {:else}
                    <button
                      class="btn btn-primary text-sm w-full flex items-center justify-center gap-2"
                      onclick={handleDownloadAndInstall}
                      disabled={isDownloadingUpdate}
                    >
                      <Download class="h-4 w-4" />
                      Download & Install v{updateInfo.version}
                    </button>
                  {/if}
                </div>
              {/if}
            </div>

            <!-- Auto-update Settings -->
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Check on startup</label>
                  <p class="text-xs text-surface-500">Automatically check for updates when the app opens</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoCheck}
                  class:bg-surface-600={!settings.updateSettings.autoCheck}
                  onclick={() => settings.setAutoCheck(!settings.updateSettings.autoCheck)}
                  aria-label="Toggle auto-check updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoCheck}
                    class:translate-x-1={!settings.updateSettings.autoCheck}
                  ></span>
                </button>
              </div>

              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Auto-download updates</label>
                  <p class="text-xs text-surface-500">Download updates automatically in the background</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoDownload}
                  class:bg-surface-600={!settings.updateSettings.autoDownload}
                  onclick={() => settings.setAutoDownload(!settings.updateSettings.autoDownload)}
                  aria-label="Toggle auto-download updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoDownload}
                    class:translate-x-1={!settings.updateSettings.autoDownload}
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      {:else if activeTab === 'advanced'}
        <div class="space-y-4">
          <!-- Story Generation Section -->
          <div class="border-b border-surface-700 pb-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStoryGenSection = !showStoryGenSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Generation</h3>
                  <p class="text-xs text-surface-500">Main AI prompts for gameplay</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStoryGenerationSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStoryGenSection = !showStoryGenSection}>
                  {#if showStoryGenSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStoryGenSection}
              <div class="mt-3 space-y-3">
                <!-- Adventure Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Adventure Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'adventure' ? null : 'adventure'}
                    >
                      {editingStoryPrompt === 'adventure' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'adventure'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.adventurePrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.adventurePrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>

                <!-- Creative Writing Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Creative Writing Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'creativeWriting' ? null : 'creativeWriting'}
                    >
                      {editingStoryPrompt === 'creativeWriting' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'creativeWriting'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.creativeWritingPrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.creativeWritingPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Wizard Generation Section -->
          <div>
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showWizardSection = !showWizardSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Wizard</h3>
                  <p class="text-xs text-surface-500">Models and prompts for wizard generation</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetAllWizardSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showWizardSection = !showWizardSection}>
                  {#if showWizardSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showWizardSection}
              <div class="mt-3 space-y-3">
                {#each Object.entries(processLabels) as [processKey, label]}
                  {@const process = processKey as keyof AdvancedWizardSettings}
                  {@const processSettings = settings.wizardSettings[process]}
                  <div class="card bg-surface-900 p-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-surface-200">{label}</span>
                      <div class="flex items-center gap-2">
                        <button
                          class="text-xs text-surface-400 hover:text-surface-200"
                          onclick={() => settings.resetWizardProcess(process)}
                          title="Reset to default"
                        >
                          <RotateCcw class="h-3 w-3" />
                        </button>
                        <button
                          class="text-xs text-accent-400 hover:text-accent-300"
                          onclick={() => editingProcess = editingProcess === process ? null : process}
                        >
                          {editingProcess === process ? 'Close' : 'Edit'}
                        </button>
                      </div>
                    </div>

                    {#if editingProcess === process}
                      <div class="space-y-3 pt-2 border-t border-surface-700">
                        <!-- Model Selection -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.wizardSettings[process].model}
                            onblur={() => settings.saveWizardSettings()}
                            placeholder={SCENARIO_MODEL}
                            class="input text-sm"
                          />
                          <p class="text-xs text-surface-500 mt-1">
                            Default: {SCENARIO_MODEL}
                          </p>
                        </div>

                        <!-- Temperature -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {processSettings.temperature?.toFixed(2) ?? 0.8}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="2"
                            step="0.05"
                            bind:value={settings.wizardSettings[process].temperature}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>Focused</span>
                            <span>Creative</span>
                          </div>
                        </div>

                        <!-- Max Tokens -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Max Tokens: {processSettings.maxTokens ?? 1000}
                          </label>
                          <input
                            type="range"
                            min="256"
                            max="4096"
                            step="128"
                            bind:value={settings.wizardSettings[process].maxTokens}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>256</span>
                            <span>4096</span>
                          </div>
                        </div>

                        <!-- System Prompt -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">System Prompt</label>
                          <textarea
                            bind:value={settings.wizardSettings[process].systemPrompt}
                            onblur={() => settings.saveWizardSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono"
                            rows="6"
                          ></textarea>
                          <p class="text-xs text-surface-500 mt-1">
                            {#if process === 'openingGeneration'}
                              Placeholders: {'{userName}'}, {'{genreLabel}'}, {'{mode}'}, {'{tense}'}, {'{tone}'}
                            {:else}
                              Customize the system prompt for this process.
                            {/if}
                          </p>
                        </div>
                      </div>
                    {:else}
                      <div class="text-xs text-surface-400">
                        <span class="text-surface-500">Model:</span> {processSettings.model || SCENARIO_MODEL}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Temp:</span> {processSettings.temperature?.toFixed(1) ?? 0.8}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Tokens:</span> {processSettings.maxTokens ?? 1000}
                      </div>
                    {/if}
                  </div>
                {/each}
              </div>
            {/if}
          </div>

          <!-- Classifier Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showClassifierSection = !showClassifierSection}
              >
                <Brain class="h-4 w-4 text-purple-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">World State Classifier</h3>
                  <p class="text-xs text-surface-500">Extracts entities from narrative responses</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetClassifierSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showClassifierSection = !showClassifierSection}>
                  {#if showClassifierSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showClassifierSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.classifier.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.classifier.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.classifier.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.classifier.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="4000"
                      step="100"
                      bind:value={settings.systemServicesSettings.classifier.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingClassifierPrompt = !editingClassifierPrompt}
                    >
                      {editingClassifierPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingClassifierPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.classifier.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.classifier.systemPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Memory Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showMemorySection = !showMemorySection}
              >
                <BookOpen class="h-4 w-4 text-blue-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Memory & Chapters</h3>
                  <p class="text-xs text-surface-500">Chapter analysis, summarization, and retrieval</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetMemorySettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showMemorySection = !showMemorySection}>
                  {#if showMemorySection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showMemorySection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.memory.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.memory.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.memory.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Chapter Analysis Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Analysis Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterAnalysis' ? null : 'chapterAnalysis'}
                      >
                        {editingMemoryPrompt === 'chapterAnalysis' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterAnalysis'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterAnalysisPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterAnalysisPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Chapter Summarization Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Summarization Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterSummarization' ? null : 'chapterSummarization'}
                      >
                        {editingMemoryPrompt === 'chapterSummarization' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterSummarization'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterSummarizationPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterSummarizationPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Retrieval Decision Prompt -->
                  <div class="border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Retrieval Decision Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'retrievalDecision' ? null : 'retrievalDecision'}
                      >
                        {editingMemoryPrompt === 'retrievalDecision' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'retrievalDecision'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.retrievalDecisionPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.retrievalDecisionPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>
                </div>
              </div>
            {/if}
          </div>

          <!-- Suggestions Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showSuggestionsSection = !showSuggestionsSection}
              >
                <Lightbulb class="h-4 w-4 text-yellow-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Suggestions</h3>
                  <p class="text-xs text-surface-500">Generates story direction suggestions</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetSuggestionsSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showSuggestionsSection = !showSuggestionsSection}>
                  {#if showSuggestionsSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showSuggestionsSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model, Temperature, and Max Tokens Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.suggestions.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.suggestions.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="2"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.suggestions.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.suggestions.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="200"
                      max="2000"
                      step="100"
                      bind:value={settings.systemServicesSettings.suggestions.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingSuggestionsPrompt = !editingSuggestionsPrompt}
                    >
                      {editingSuggestionsPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingSuggestionsPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.suggestions.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[100px] resize-y font-mono w-full"
                      rows="5"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.suggestions.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Style Reviewer Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStyleReviewerSection = !showStyleReviewerSection}
              >
                <Sparkles class="h-4 w-4 text-pink-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Style Reviewer</h3>
                  <p class="text-xs text-surface-500">Analyzes prose for repetitive phrases</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.styleReviewer.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.styleReviewer.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.styleReviewer.enabled =
                      !settings.systemServicesSettings.styleReviewer.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle style reviewer"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.styleReviewer.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.styleReviewer.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStyleReviewerSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStyleReviewerSection = !showStyleReviewerSection}>
                  {#if showStyleReviewerSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStyleReviewerSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.styleReviewer.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="x-ai/grok-4.1-fast"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.styleReviewer.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.styleReviewer.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Trigger Interval -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Review Interval: Every {settings.systemServicesSettings.styleReviewer.triggerInterval} messages
                    </label>
                    <input
                      type="range"
                      min="3"
                      max="15"
                      step="1"
                      bind:value={settings.systemServicesSettings.styleReviewer.triggerInterval}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                    <div class="flex justify-between text-xs text-surface-500">
                      <span>More Frequent</span>
                      <span>Less Frequent</span>
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.styleReviewer.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="3000"
                      step="100"
                      bind:value={settings.systemServicesSettings.styleReviewer.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStyleReviewerPrompt = !editingStyleReviewerPrompt}
                    >
                      {editingStyleReviewerPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStyleReviewerPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.styleReviewer.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[150px] resize-y font-mono w-full"
                      rows="8"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.styleReviewer.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Timeline Fill Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showTimelineFillSection = !showTimelineFillSection}
              >
                <Clock class="h-4 w-4 text-cyan-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Timeline Fill</h3>
                  <p class="text-xs text-surface-500">Retrieves context from past chapters</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.timelineFill.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.timelineFill.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.timelineFill.enabled =
                      !settings.systemServicesSettings.timelineFill.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle timeline fill"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.timelineFill.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.timelineFill.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetTimelineFillSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showTimelineFillSection = !showTimelineFillSection}>
                  {#if showTimelineFillSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showTimelineFillSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <p class="text-xs text-surface-400 mb-3">
                    Timeline Fill retrieves context from past chapters to maintain story consistency.
                    Choose between static (faster, one-shot queries) or agentic (iterative tool-calling) mode.
                  </p>

                  <!-- Mode Selector -->
                  <div class="mb-3">
                    <label class="mb-2 block text-xs font-medium text-surface-400">Retrieval Mode</label>
                    <div class="flex gap-2">
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'static';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Static</div>
                        <div class="text-xs opacity-75 mt-0.5">One-shot queries (default)</div>
                      </button>
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'agentic';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Agentic</div>
                        <div class="text-xs opacity-75 mt-0.5">Iterative tool-calling</div>
                      </button>
                    </div>
                  </div>

                  {#if settings.systemServicesSettings.timelineFill.mode === 'static'}
                    <!-- Static Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <!-- Model and Temperature Row -->
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.timelineFill.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="x-ai/grok-4.1-fast"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.timelineFill.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.timelineFill.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <!-- Max Queries -->
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Queries: {settings.systemServicesSettings.timelineFill.maxQueries}
                        </label>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          step="1"
                          bind:value={settings.systemServicesSettings.timelineFill.maxQueries}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer (faster)</span>
                          <span>More (thorough)</span>
                        </div>
                      </div>

                      <!-- Query Generation Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Generation Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'system' ? null : 'system'}
                          >
                            {editingTimelineFillPrompt === 'system' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'system'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[150px] resize-y font-mono w-full"
                            rows="8"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>

                      <!-- Query Answer Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Answer Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'answer' ? null : 'answer'}
                          >
                            {editingTimelineFillPrompt === 'answer' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'answer'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.queryAnswerPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[100px] resize-y font-mono w-full"
                            rows="5"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.queryAnswerPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {:else}
                    <!-- Agentic Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="minimax/minimax-m2.1"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.agenticRetrieval.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Iterations: {settings.systemServicesSettings.agenticRetrieval.maxIterations}
                        </label>
                        <input
                          type="range"
                          min="3"
                          max="30"
                          step="1"
                          bind:value={settings.systemServicesSettings.agenticRetrieval.maxIterations}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer iterations</span>
                          <span>More thorough</span>
                        </div>
                      </div>

                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Agentic Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingAgenticRetrievalPrompt = !editingAgenticRetrievalPrompt}
                          >
                            {editingAgenticRetrievalPrompt ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingAgenticRetrievalPrompt}
                          <textarea
                            bind:value={settings.systemServicesSettings.agenticRetrieval.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono w-full"
                            rows="6"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.agenticRetrieval.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Reset All Settings -->
          <div class="mt-6 pt-6 border-t border-red-500/30">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-red-400">Reset All Settings</h3>
                <p class="text-xs text-surface-500 mt-1">
                  Reset all settings to their default values. Your API key will be preserved.
                </p>
              </div>
              <button
                class="px-4 py-2 text-sm font-medium text-red-400 border border-red-500/50 rounded-lg hover:bg-red-500/20 transition-colors flex items-center gap-2"
                onclick={handleResetAll}
              >
                <RotateCcw class="h-4 w-4" />
                Reset All
              </button>
            </div>
          </div>
        </div>
      {/if}
    </div>
  </div>
</div>

/app/src/lib/components/settings/SettingsModal.svelte:286:3
Warn: `<div>` with a click handler must have an ARIA role
https://svelte.dev/e/a11y_no_static_element_interactions (svelte)
<div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60" onclick={() => ui.closeSettings()}>
  <div
    class="card w-full sm:max-w-2xl max-h-[95vh] sm:max-h-[80vh] overflow-hidden rounded-b-none sm:rounded-b-xl flex flex-col"
    onclick={(e) => e.stopPropagation()}
    use:swipe={{ onSwipeDown: handleSwipeDown, threshold: 50 }}
  >
    <!-- Mobile swipe handle indicator -->
    <div class="sm:hidden flex justify-center pt-2 pb-1">
      <div class="w-10 h-1 rounded-full bg-surface-600"></div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between border-b border-surface-700 pb-3 sm:pb-4 pt-0 sm:pt-0 flex-shrink-0">
      <h2 class="text-lg sm:text-xl font-semibold text-surface-100">Settings</h2>
      <button class="btn-ghost rounded-lg p-2 min-h-[44px] min-w-[44px] flex items-center justify-center" onclick={() => ui.closeSettings()}>
        <X class="h-5 w-5" />
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-1 border-b border-surface-700 py-2 overflow-x-auto scrollbar-hide flex-shrink-0 -mx-4 px-4 sm:mx-0 sm:px-0">
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'api'}
        class:text-surface-100={activeTab === 'api'}
        class:text-surface-400={activeTab !== 'api'}
        onclick={() => activeTab = 'api'}
      >
        <Key class="h-4 w-4" />
        <span>API</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'generation'}
        class:text-surface-100={activeTab === 'generation'}
        class:text-surface-400={activeTab !== 'generation'}
        onclick={() => activeTab = 'generation'}
      >
        <Cpu class="h-4 w-4" />
        <span class="hidden xs:inline">Generation</span>
        <span class="xs:hidden">Gen</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'ui'}
        class:text-surface-100={activeTab === 'ui'}
        class:text-surface-400={activeTab !== 'ui'}
        onclick={() => activeTab = 'ui'}
      >
        <Palette class="h-4 w-4" />
        <span class="hidden xs:inline">Interface</span>
        <span class="xs:hidden">UI</span>
      </button>
      <button
        class="flex items-center gap-1.5 sm:gap-2 rounded-lg px-3 sm:px-4 py-2 text-sm min-h-[40px] flex-shrink-0"
        class:bg-surface-700={activeTab === 'advanced'}
        class:text-surface-100={activeTab === 'advanced'}
        class:text-surface-400={activeTab !== 'advanced'}
        onclick={() => activeTab = 'advanced'}
      >
        <Settings2 class="h-4 w-4" />
        <span class="hidden xs:inline">Advanced</span>
        <span class="xs:hidden">Adv</span>
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto py-4 min-h-0">
      {#if activeTab === 'api'}
        <div class="space-y-4">
          <!-- Provider Selection -->
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              AI Provider
            </label>
            <div class="flex gap-2">
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'openrouter'}
                class:border-accent-500={settings.apiSettings.provider === 'openrouter'}
                class:text-white={settings.apiSettings.provider === 'openrouter'}
                class:bg-surface-700={settings.apiSettings.provider !== 'openrouter'}
                class:border-surface-600={settings.apiSettings.provider !== 'openrouter'}
                class:text-surface-300={settings.apiSettings.provider !== 'openrouter'}
                onclick={async () => {
                  await settings.setProvider('openrouter');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">OpenRouter</div>
                <div class="text-xs opacity-75 mt-0.5">Aggregator (Many models)</div>
              </button>
              <button
                class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                class:bg-accent-600={settings.apiSettings.provider === 'nanogpt'}
                class:border-accent-500={settings.apiSettings.provider === 'nanogpt'}
                class:text-white={settings.apiSettings.provider === 'nanogpt'}
                class:bg-surface-700={settings.apiSettings.provider !== 'nanogpt'}
                class:border-surface-600={settings.apiSettings.provider !== 'nanogpt'}
                class:text-surface-300={settings.apiSettings.provider !== 'nanogpt'}
                onclick={async () => {
                  await settings.setProvider('nanogpt');
                  handleRefreshModels();
                }}
              >
                <div class="font-medium">NanoGPT</div>
                <div class="text-xs opacity-75 mt-0.5">Pay-per-prompt</div>
              </button>
            </div>
          </div>

          {#if settings.apiSettings.provider === 'openrouter'}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                OpenRouter API Key
              </label>
              {#if apiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearOpenRouterApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={apiKeyInput}
                    placeholder="sk-or-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveOpenRouterApiKey}
                    disabled={!apiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://openrouter.ai/keys" target="_blank" class="text-accent-400 hover:underline">openrouter.ai</a>
              </p>
            </div>
          {:else}
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                NanoGPT API Key
              </label>
              {#if nanogptApiKeySet}
                <div class="flex items-center gap-2">
                  <div class="input flex-1 bg-surface-700 text-surface-400">
                    ••••••••••••••••••••
                  </div>
                  <button class="btn btn-secondary" onclick={clearNanoGPTApiKey}>
                    Clear
                  </button>
                </div>
                <p class="mt-1 text-sm text-green-400">API key configured</p>
              {:else}
                <div class="flex gap-2">
                  <input
                    type="password"
                    bind:value={nanogptApiKeyInput}
                    placeholder="nano-..."
                    class="input flex-1"
                  />
                  <button
                    class="btn btn-primary"
                    onclick={saveNanoGPTApiKey}
                    disabled={!nanogptApiKeyInput.trim()}
                  >
                    Save
                  </button>
                </div>
              {/if}
              <p class="mt-2 text-sm text-surface-500">
                Get your API key from <a href="https://nano-gpt.com" target="_blank" class="text-accent-400 hover:underline">nano-gpt.com</a>
              </p>
            </div>
          {/if}

          <div>
            <div class="mb-2 flex items-center justify-between">
              <label class="text-sm font-medium text-surface-300">
                Default Model
              </label>
              <button
                class="flex items-center gap-1 text-xs text-accent-400 hover:text-accent-300 disabled:opacity-50"
                onclick={handleRefreshModels}
                disabled={isLoadingModels}
              >
                <span class={isLoadingModels ? 'animate-spin' : ''}>
                  <RefreshCw class="h-3 w-3" />
                </span>
                Refresh
              </button>
            </div>

            {#if modelError}
              <p class="mb-2 text-xs text-amber-400">{modelError}</p>
            {/if}

            <!-- Search input -->
            <div class="relative mb-2">
              <Search class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-surface-500" />
              <input
                type="text"
                bind:value={modelSearch}
                placeholder="Search models..."
                class="input pl-9 text-sm"
              />
            </div>

            <!-- Model select -->
            <select
              class="input"
              value={settings.apiSettings.defaultModel}
              onchange={(e) => settings.setDefaultModel(e.currentTarget.value)}
              disabled={isLoadingModels}
            >
              {#if isLoadingModels}
                <option>Loading models...</option>
              {:else}
                {#each filteredModels as model}
                  <option value={model.id}>
                    {model.name} ({formatContextLength(model.contextLength)} ctx)
                  </option>
                {/each}
              {/if}
            </select>

            {#if models.length > 0}
              <p class="mt-1 text-xs text-surface-500">
                {models.length} models available
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'generation'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Temperature: {settings.apiSettings.temperature.toFixed(1)}
            </label>
            <input
              type="range"
              min="0"
              max="2"
              step="0.1"
              value={settings.apiSettings.temperature}
              oninput={(e) => settings.setTemperature(parseFloat(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Focused</span>
              <span>Creative</span>
            </div>
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Max Tokens: {settings.apiSettings.maxTokens}
            </label>
            <input
              type="range"
              min="256"
              max="4096"
              step="128"
              value={settings.apiSettings.maxTokens}
              oninput={(e) => settings.setMaxTokens(parseInt(e.currentTarget.value))}
              class="w-full"
            />
            <div class="flex justify-between text-xs text-surface-500">
              <span>Shorter</span>
              <span>Longer</span>
            </div>
          </div>

          <!-- Extended Thinking Toggle -->
          <div class="border-t border-surface-700 pt-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <Sparkles class="h-5 w-5 text-amber-400" />
                <div>
                  <label class="text-sm font-medium text-surface-300">Extended Thinking</label>
                  <p class="text-xs text-surface-500">
                    Enable reasoning for supported models (e.g., GLM 4.7, DeepSeek v3.2)
                  </p>
                </div>
              </div>
              <button
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                class:bg-accent-600={settings.apiSettings.enableThinking}
                class:bg-surface-600={!settings.apiSettings.enableThinking}
                onclick={() => settings.setEnableThinking(!settings.apiSettings.enableThinking)}
                aria-label="Toggle extended thinking"
              >
                <span
                  class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                  class:translate-x-6={settings.apiSettings.enableThinking}
                  class:translate-x-1={!settings.apiSettings.enableThinking}
                ></span>
              </button>
            </div>
            {#if settings.apiSettings.enableThinking}
              <p class="mt-2 text-xs text-amber-400/80 ml-8">
                The model will use internal reasoning to improve responses. Reasoning is not shown or stored.
              </p>
            {/if}
          </div>
        </div>
      {:else if activeTab === 'ui'}
        <div class="space-y-4">
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Theme
            </label>
            <select
              class="input"
              value={settings.uiSettings.theme}
              onchange={(e) => settings.setTheme(e.currentTarget.value as ThemeId)}
            >
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="retro-console">Retro Console</option>
            </select>
            {#if settings.uiSettings.theme === 'retro-console'}
              <p class="mt-1 text-xs text-surface-400">
                CRT aesthetic inspired by PS2-era games and Serial Experiments Lain
              </p>
            {/if}
          </div>

          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Font Size
            </label>
            <select
              class="input"
              value={settings.uiSettings.fontSize}
              onchange={(e) => settings.setFontSize(e.currentTarget.value as 'small' | 'medium' | 'large')}
            >
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-surface-300">Show Word Count</label>
            <input
              type="checkbox"
              checked={settings.uiSettings.showWordCount}
              onchange={() => {
                settings.uiSettings.showWordCount = !settings.uiSettings.showWordCount;
              }}
              class="h-5 w-5 rounded border-surface-600 bg-surface-700"
            />
          </div>

          <div class="flex items-center justify-between">
            <div>
              <label class="text-sm font-medium text-surface-300">Spellcheck</label>
              <p class="text-xs text-surface-500">Grammar and spelling suggestions while typing</p>
            </div>
            <button
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
              class:bg-accent-600={settings.uiSettings.spellcheckEnabled}
              class:bg-surface-600={!settings.uiSettings.spellcheckEnabled}
              onclick={() => settings.setSpellcheckEnabled(!settings.uiSettings.spellcheckEnabled)}
              aria-label="Toggle spellcheck"
            >
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                class:translate-x-6={settings.uiSettings.spellcheckEnabled}
                class:translate-x-1={!settings.uiSettings.spellcheckEnabled}
              ></span>
            </button>
          </div>

          <!-- Updates Section -->
          <div class="border-t border-surface-700 pt-4 mt-4">
            <div class="flex items-center gap-2 mb-3">
              <Download class="h-5 w-5 text-accent-400" />
              <h3 class="text-sm font-medium text-surface-200">Updates</h3>
            </div>

            <!-- Update Status -->
            <div class="card bg-surface-900 p-3 mb-3">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <p class="text-sm text-surface-200">
                    {#if updateInfo?.available}
                      Update available: v{updateInfo.version}
                    {:else if updateInfo !== null}
                      You're up to date
                    {:else}
                      Check for updates
                    {/if}
                  </p>
                  <p class="text-xs text-surface-500">
                    Last checked: {formatLastChecked(settings.updateSettings.lastChecked)}
                  </p>
                </div>
                <button
                  class="btn btn-secondary text-sm flex items-center gap-2"
                  onclick={handleCheckForUpdates}
                  disabled={isCheckingUpdates || isDownloadingUpdate}
                >
                  {#if isCheckingUpdates}
                    <Loader2 class="h-4 w-4 animate-spin" />
                    Checking...
                  {:else}
                    <RefreshCw class="h-4 w-4" />
                    Check
                  {/if}
                </button>
              </div>

              {#if updateError}
                <p class="text-xs text-red-400 mt-2">{updateError}</p>
              {/if}

              {#if updateInfo?.available}
                <div class="mt-3 pt-3 border-t border-surface-700">
                  {#if updateInfo.body}
                    <p class="text-xs text-surface-400 mb-3 line-clamp-3">{updateInfo.body}</p>
                  {/if}

                  {#if isDownloadingUpdate && downloadProgress}
                    <div class="mb-2">
                      <div class="flex justify-between text-xs text-surface-400 mb-1">
                        <span>Downloading...</span>
                        <span>
                          {#if downloadProgress.total}
                            {Math.round((downloadProgress.downloaded / downloadProgress.total) * 100)}%
                          {:else}
                            {Math.round(downloadProgress.downloaded / 1024 / 1024)}MB
                          {/if}
                        </span>
                      </div>
                      <div class="h-2 bg-surface-700 rounded-full overflow-hidden">
                        <div
                          class="h-full bg-accent-500 transition-all duration-300"
                          style="width: {downloadProgress.total ? (downloadProgress.downloaded / downloadProgress.total) * 100 : 50}%"
                        ></div>
                      </div>
                    </div>
                  {:else}
                    <button
                      class="btn btn-primary text-sm w-full flex items-center justify-center gap-2"
                      onclick={handleDownloadAndInstall}
                      disabled={isDownloadingUpdate}
                    >
                      <Download class="h-4 w-4" />
                      Download & Install v{updateInfo.version}
                    </button>
                  {/if}
                </div>
              {/if}
            </div>

            <!-- Auto-update Settings -->
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Check on startup</label>
                  <p class="text-xs text-surface-500">Automatically check for updates when the app opens</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoCheck}
                  class:bg-surface-600={!settings.updateSettings.autoCheck}
                  onclick={() => settings.setAutoCheck(!settings.updateSettings.autoCheck)}
                  aria-label="Toggle auto-check updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoCheck}
                    class:translate-x-1={!settings.updateSettings.autoCheck}
                  ></span>
                </button>
              </div>

              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-surface-300">Auto-download updates</label>
                  <p class="text-xs text-surface-500">Download updates automatically in the background</p>
                </div>
                <button
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.updateSettings.autoDownload}
                  class:bg-surface-600={!settings.updateSettings.autoDownload}
                  onclick={() => settings.setAutoDownload(!settings.updateSettings.autoDownload)}
                  aria-label="Toggle auto-download updates"
                >
                  <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                    class:translate-x-6={settings.updateSettings.autoDownload}
                    class:translate-x-1={!settings.updateSettings.autoDownload}
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      {:else if activeTab === 'advanced'}
        <div class="space-y-4">
          <!-- Story Generation Section -->
          <div class="border-b border-surface-700 pb-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStoryGenSection = !showStoryGenSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Generation</h3>
                  <p class="text-xs text-surface-500">Main AI prompts for gameplay</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStoryGenerationSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStoryGenSection = !showStoryGenSection}>
                  {#if showStoryGenSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStoryGenSection}
              <div class="mt-3 space-y-3">
                <!-- Adventure Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Adventure Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'adventure' ? null : 'adventure'}
                    >
                      {editingStoryPrompt === 'adventure' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'adventure'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.adventurePrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.adventurePrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>

                <!-- Creative Writing Mode Prompt -->
                <div class="card bg-surface-900 p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-surface-200">Creative Writing Mode Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStoryPrompt = editingStoryPrompt === 'creativeWriting' ? null : 'creativeWriting'}
                    >
                      {editingStoryPrompt === 'creativeWriting' ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStoryPrompt === 'creativeWriting'}
                    <textarea
                      bind:value={settings.storyGenerationSettings.creativeWritingPrompt}
                      onblur={() => settings.saveStoryGenerationSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.storyGenerationSettings.creativeWritingPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Wizard Generation Section -->
          <div>
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showWizardSection = !showWizardSection}
              >
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Wizard</h3>
                  <p class="text-xs text-surface-500">Models and prompts for wizard generation</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetAllWizardSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showWizardSection = !showWizardSection}>
                  {#if showWizardSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showWizardSection}
              <div class="mt-3 space-y-3">
                {#each Object.entries(processLabels) as [processKey, label]}
                  {@const process = processKey as keyof AdvancedWizardSettings}
                  {@const processSettings = settings.wizardSettings[process]}
                  <div class="card bg-surface-900 p-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-surface-200">{label}</span>
                      <div class="flex items-center gap-2">
                        <button
                          class="text-xs text-surface-400 hover:text-surface-200"
                          onclick={() => settings.resetWizardProcess(process)}
                          title="Reset to default"
                        >
                          <RotateCcw class="h-3 w-3" />
                        </button>
                        <button
                          class="text-xs text-accent-400 hover:text-accent-300"
                          onclick={() => editingProcess = editingProcess === process ? null : process}
                        >
                          {editingProcess === process ? 'Close' : 'Edit'}
                        </button>
                      </div>
                    </div>

                    {#if editingProcess === process}
                      <div class="space-y-3 pt-2 border-t border-surface-700">
                        <!-- Model Selection -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.wizardSettings[process].model}
                            onblur={() => settings.saveWizardSettings()}
                            placeholder={SCENARIO_MODEL}
                            class="input text-sm"
                          />
                          <p class="text-xs text-surface-500 mt-1">
                            Default: {SCENARIO_MODEL}
                          </p>
                        </div>

                        <!-- Temperature -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {processSettings.temperature?.toFixed(2) ?? 0.8}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="2"
                            step="0.05"
                            bind:value={settings.wizardSettings[process].temperature}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>Focused</span>
                            <span>Creative</span>
                          </div>
                        </div>

                        <!-- Max Tokens -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Max Tokens: {processSettings.maxTokens ?? 1000}
                          </label>
                          <input
                            type="range"
                            min="256"
                            max="4096"
                            step="128"
                            bind:value={settings.wizardSettings[process].maxTokens}
                            onchange={() => settings.saveWizardSettings()}
                            class="w-full h-2"
                          />
                          <div class="flex justify-between text-xs text-surface-500">
                            <span>256</span>
                            <span>4096</span>
                          </div>
                        </div>

                        <!-- System Prompt -->
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">System Prompt</label>
                          <textarea
                            bind:value={settings.wizardSettings[process].systemPrompt}
                            onblur={() => settings.saveWizardSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono"
                            rows="6"
                          ></textarea>
                          <p class="text-xs text-surface-500 mt-1">
                            {#if process === 'openingGeneration'}
                              Placeholders: {'{userName}'}, {'{genreLabel}'}, {'{mode}'}, {'{tense}'}, {'{tone}'}
                            {:else}
                              Customize the system prompt for this process.
                            {/if}
                          </p>
                        </div>
                      </div>
                    {:else}
                      <div class="text-xs text-surface-400">
                        <span class="text-surface-500">Model:</span> {processSettings.model || SCENARIO_MODEL}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Temp:</span> {processSettings.temperature?.toFixed(1) ?? 0.8}
                        <span class="mx-2">•</span>
                        <span class="text-surface-500">Tokens:</span> {processSettings.maxTokens ?? 1000}
                      </div>
                    {/if}
                  </div>
                {/each}
              </div>
            {/if}
          </div>

          <!-- Classifier Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showClassifierSection = !showClassifierSection}
              >
                <Brain class="h-4 w-4 text-purple-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">World State Classifier</h3>
                  <p class="text-xs text-surface-500">Extracts entities from narrative responses</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetClassifierSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showClassifierSection = !showClassifierSection}>
                  {#if showClassifierSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showClassifierSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.classifier.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.classifier.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.classifier.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.classifier.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="4000"
                      step="100"
                      bind:value={settings.systemServicesSettings.classifier.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingClassifierPrompt = !editingClassifierPrompt}
                    >
                      {editingClassifierPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingClassifierPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.classifier.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[200px] resize-y font-mono w-full"
                      rows="10"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.classifier.systemPrompt.slice(0, 150)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Memory Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showMemorySection = !showMemorySection}
              >
                <BookOpen class="h-4 w-4 text-blue-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Memory & Chapters</h3>
                  <p class="text-xs text-surface-500">Chapter analysis, summarization, and retrieval</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetMemorySettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showMemorySection = !showMemorySection}>
                  {#if showMemorySection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showMemorySection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.memory.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.memory.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.memory.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Chapter Analysis Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Analysis Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterAnalysis' ? null : 'chapterAnalysis'}
                      >
                        {editingMemoryPrompt === 'chapterAnalysis' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterAnalysis'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterAnalysisPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterAnalysisPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Chapter Summarization Prompt -->
                  <div class="mb-3 border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Chapter Summarization Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'chapterSummarization' ? null : 'chapterSummarization'}
                      >
                        {editingMemoryPrompt === 'chapterSummarization' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'chapterSummarization'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.chapterSummarizationPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.chapterSummarizationPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>

                  <!-- Retrieval Decision Prompt -->
                  <div class="border-t border-surface-700 pt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-surface-400">Retrieval Decision Prompt</span>
                      <button
                        class="text-xs text-accent-400 hover:text-accent-300"
                        onclick={() => editingMemoryPrompt = editingMemoryPrompt === 'retrievalDecision' ? null : 'retrievalDecision'}
                      >
                        {editingMemoryPrompt === 'retrievalDecision' ? 'Close' : 'Edit'}
                      </button>
                    </div>
                    {#if editingMemoryPrompt === 'retrievalDecision'}
                      <textarea
                        bind:value={settings.systemServicesSettings.memory.retrievalDecisionPrompt}
                        onblur={() => settings.saveSystemServicesSettings()}
                        class="input text-xs min-h-[100px] resize-y font-mono w-full"
                        rows="5"
                      ></textarea>
                    {:else}
                      <p class="text-xs text-surface-400 line-clamp-2">
                        {settings.systemServicesSettings.memory.retrievalDecisionPrompt.slice(0, 100)}...
                      </p>
                    {/if}
                  </div>
                </div>
              </div>
            {/if}
          </div>

          <!-- Suggestions Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showSuggestionsSection = !showSuggestionsSection}
              >
                <Lightbulb class="h-4 w-4 text-yellow-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Story Suggestions</h3>
                  <p class="text-xs text-surface-500">Generates story direction suggestions</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetSuggestionsSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showSuggestionsSection = !showSuggestionsSection}>
                  {#if showSuggestionsSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showSuggestionsSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model, Temperature, and Max Tokens Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.suggestions.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="deepseek/deepseek-v3.2"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.suggestions.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="2"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.suggestions.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.suggestions.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="200"
                      max="2000"
                      step="100"
                      bind:value={settings.systemServicesSettings.suggestions.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingSuggestionsPrompt = !editingSuggestionsPrompt}
                    >
                      {editingSuggestionsPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingSuggestionsPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.suggestions.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[100px] resize-y font-mono w-full"
                      rows="5"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.suggestions.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Style Reviewer Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showStyleReviewerSection = !showStyleReviewerSection}
              >
                <Sparkles class="h-4 w-4 text-pink-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Style Reviewer</h3>
                  <p class="text-xs text-surface-500">Analyzes prose for repetitive phrases</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.styleReviewer.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.styleReviewer.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.styleReviewer.enabled =
                      !settings.systemServicesSettings.styleReviewer.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle style reviewer"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.styleReviewer.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.styleReviewer.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetStyleReviewerSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showStyleReviewerSection = !showStyleReviewerSection}>
                  {#if showStyleReviewerSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showStyleReviewerSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <!-- Model and Temperature Row -->
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input
                        type="text"
                        bind:value={settings.systemServicesSettings.styleReviewer.model}
                        onblur={() => settings.saveSystemServicesSettings()}
                        placeholder="x-ai/grok-4.1-fast"
                        class="input text-sm"
                      />
                    </div>
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.styleReviewer.temperature.toFixed(2)}
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        bind:value={settings.systemServicesSettings.styleReviewer.temperature}
                        onchange={() => settings.saveSystemServicesSettings()}
                        class="w-full h-2"
                      />
                    </div>
                  </div>

                  <!-- Trigger Interval -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Review Interval: Every {settings.systemServicesSettings.styleReviewer.triggerInterval} messages
                    </label>
                    <input
                      type="range"
                      min="3"
                      max="15"
                      step="1"
                      bind:value={settings.systemServicesSettings.styleReviewer.triggerInterval}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                    <div class="flex justify-between text-xs text-surface-500">
                      <span>More Frequent</span>
                      <span>Less Frequent</span>
                    </div>
                  </div>

                  <!-- Max Tokens -->
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.styleReviewer.maxTokens}
                    </label>
                    <input
                      type="range"
                      min="500"
                      max="3000"
                      step="100"
                      bind:value={settings.systemServicesSettings.styleReviewer.maxTokens}
                      onchange={() => settings.saveSystemServicesSettings()}
                      class="w-full h-2"
                    />
                  </div>

                  <!-- System Prompt -->
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-surface-400">System Prompt</span>
                    <button
                      class="text-xs text-accent-400 hover:text-accent-300"
                      onclick={() => editingStyleReviewerPrompt = !editingStyleReviewerPrompt}
                    >
                      {editingStyleReviewerPrompt ? 'Close' : 'Edit'}
                    </button>
                  </div>
                  {#if editingStyleReviewerPrompt}
                    <textarea
                      bind:value={settings.systemServicesSettings.styleReviewer.systemPrompt}
                      onblur={() => settings.saveSystemServicesSettings()}
                      class="input text-xs min-h-[150px] resize-y font-mono w-full"
                      rows="8"
                    ></textarea>
                  {:else}
                    <p class="text-xs text-surface-400 line-clamp-2">
                      {settings.systemServicesSettings.styleReviewer.systemPrompt.slice(0, 100)}...
                    </p>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Timeline Fill Section -->
          <div class="border-t border-surface-700 pt-3">
            <div class="flex items-center justify-between">
              <button
                class="flex items-center gap-2 text-left flex-1"
                onclick={() => showTimelineFillSection = !showTimelineFillSection}
              >
                <Clock class="h-4 w-4 text-cyan-400" />
                <div>
                  <h3 class="text-sm font-medium text-surface-200">Timeline Fill</h3>
                  <p class="text-xs text-surface-500">Retrieves context from past chapters</p>
                </div>
              </button>
              <div class="flex items-center gap-2">
                <!-- Enable/Disable Toggle -->
                <button
                  class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors"
                  class:bg-accent-600={settings.systemServicesSettings.timelineFill.enabled}
                  class:bg-surface-600={!settings.systemServicesSettings.timelineFill.enabled}
                  onclick={async () => {
                    settings.systemServicesSettings.timelineFill.enabled =
                      !settings.systemServicesSettings.timelineFill.enabled;
                    await settings.saveSystemServicesSettings();
                  }}
                  aria-label="Toggle timeline fill"
                >
                  <span
                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                    class:translate-x-5={settings.systemServicesSettings.timelineFill.enabled}
                    class:translate-x-1={!settings.systemServicesSettings.timelineFill.enabled}
                  ></span>
                </button>
                <button
                  class="text-xs text-accent-400 hover:text-accent-300 flex items-center gap-1"
                  onclick={() => settings.resetTimelineFillSettings()}
                >
                  <RotateCcw class="h-3 w-3" />
                  Reset
                </button>
                <button onclick={() => showTimelineFillSection = !showTimelineFillSection}>
                  {#if showTimelineFillSection}
                    <ChevronUp class="h-4 w-4 text-surface-400" />
                  {:else}
                    <ChevronDown class="h-4 w-4 text-surface-400" />
                  {/if}
                </button>
              </div>
            </div>

            {#if showTimelineFillSection}
              <div class="mt-3 space-y-3">
                <div class="card bg-surface-900 p-3">
                  <p class="text-xs text-surface-400 mb-3">
                    Timeline Fill retrieves context from past chapters to maintain story consistency.
                    Choose between static (faster, one-shot queries) or agentic (iterative tool-calling) mode.
                  </p>

                  <!-- Mode Selector -->
                  <div class="mb-3">
                    <label class="mb-2 block text-xs font-medium text-surface-400">Retrieval Mode</label>
                    <div class="flex gap-2">
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'static'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'static'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'static';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Static</div>
                        <div class="text-xs opacity-75 mt-0.5">One-shot queries (default)</div>
                      </button>
                      <button
                        class="flex-1 px-3 py-2 text-xs rounded-lg border transition-colors"
                        class:bg-accent-600={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:border-accent-500={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:text-white={settings.systemServicesSettings.timelineFill.mode === 'agentic'}
                        class:bg-surface-700={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:border-surface-600={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        class:text-surface-300={settings.systemServicesSettings.timelineFill.mode !== 'agentic'}
                        onclick={async () => {
                          settings.systemServicesSettings.timelineFill.mode = 'agentic';
                          await settings.saveSystemServicesSettings();
                        }}
                      >
                        <div class="font-medium">Agentic</div>
                        <div class="text-xs opacity-75 mt-0.5">Iterative tool-calling</div>
                      </button>
                    </div>
                  </div>

                  {#if settings.systemServicesSettings.timelineFill.mode === 'static'}
                    <!-- Static Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <!-- Model and Temperature Row -->
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.timelineFill.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="x-ai/grok-4.1-fast"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.timelineFill.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.timelineFill.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <!-- Max Queries -->
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Queries: {settings.systemServicesSettings.timelineFill.maxQueries}
                        </label>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          step="1"
                          bind:value={settings.systemServicesSettings.timelineFill.maxQueries}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer (faster)</span>
                          <span>More (thorough)</span>
                        </div>
                      </div>

                      <!-- Query Generation Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Generation Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'system' ? null : 'system'}
                          >
                            {editingTimelineFillPrompt === 'system' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'system'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[150px] resize-y font-mono w-full"
                            rows="8"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>

                      <!-- Query Answer Prompt -->
                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Query Answer Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingTimelineFillPrompt = editingTimelineFillPrompt === 'answer' ? null : 'answer'}
                          >
                            {editingTimelineFillPrompt === 'answer' ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingTimelineFillPrompt === 'answer'}
                          <textarea
                            bind:value={settings.systemServicesSettings.timelineFill.queryAnswerPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[100px] resize-y font-mono w-full"
                            rows="5"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.timelineFill.queryAnswerPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {:else}
                    <!-- Agentic Mode Settings -->
                    <div class="border-t border-surface-700 pt-3 space-y-3">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input
                            type="text"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.model}
                            onblur={() => settings.saveSystemServicesSettings()}
                            placeholder="minimax/minimax-m2.1"
                            class="input text-sm"
                          />
                        </div>
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.agenticRetrieval.temperature.toFixed(2)}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.05"
                            bind:value={settings.systemServicesSettings.agenticRetrieval.temperature}
                            onchange={() => settings.saveSystemServicesSettings()}
                            class="w-full h-2"
                          />
                        </div>
                      </div>

                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Iterations: {settings.systemServicesSettings.agenticRetrieval.maxIterations}
                        </label>
                        <input
                          type="range"
                          min="3"
                          max="30"
                          step="1"
                          bind:value={settings.systemServicesSettings.agenticRetrieval.maxIterations}
                          onchange={() => settings.saveSystemServicesSettings()}
                          class="w-full h-2"
                        />
                        <div class="flex justify-between text-xs text-surface-500">
                          <span>Fewer iterations</span>
                          <span>More thorough</span>
                        </div>
                      </div>

                      <div class="border-t border-surface-700 pt-3">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium text-surface-400">Agentic Prompt</span>
                          <button
                            class="text-xs text-accent-400 hover:text-accent-300"
                            onclick={() => editingAgenticRetrievalPrompt = !editingAgenticRetrievalPrompt}
                          >
                            {editingAgenticRetrievalPrompt ? 'Close' : 'Edit'}
                          </button>
                        </div>
                        {#if editingAgenticRetrievalPrompt}
                          <textarea
                            bind:value={settings.systemServicesSettings.agenticRetrieval.systemPrompt}
                            onblur={() => settings.saveSystemServicesSettings()}
                            class="input text-xs min-h-[120px] resize-y font-mono w-full"
                            rows="6"
                          ></textarea>
                        {:else}
                          <p class="text-xs text-surface-400 line-clamp-2">
                            {settings.systemServicesSettings.agenticRetrieval.systemPrompt.slice(0, 100)}...
                          </p>
                        {/if}
                      </div>
                    </div>
                  {/if}
                </div>
              </div>
            {/if}
          </div>

          <!-- Reset All Settings -->
          <div class="mt-6 pt-6 border-t border-red-500/30">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium text-red-400">Reset All Settings</h3>
                <p class="text-xs text-surface-500 mt-1">
                  Reset all settings to their default values. Your API key will be preserved.
                </p>
              </div>
              <button
                class="px-4 py-2 text-sm font-medium text-red-400 border border-red-500/50 rounded-lg hover:bg-red-500/20 transition-colors flex items-center gap-2"
                onclick={handleResetAll}
              >
                <RotateCcw class="h-4 w-4" />
                Reset All
              </button>
            </div>
          </div>
        </div>
      {/if}
    </div>
  </div>
</div>

/app/src/lib/components/settings/SettingsModal.svelte:357:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              AI Provider
            </label>
            <div class="flex gap-2">

/app/src/lib/components/settings/SettingsModal.svelte:398:15
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                OpenRouter API Key
              </label>
              {#if apiKeySet}

/app/src/lib/components/settings/SettingsModal.svelte:434:15
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
            <div>
              <label class="mb-2 block text-sm font-medium text-surface-300">
                NanoGPT API Key
              </label>
              {#if nanogptApiKeySet}

/app/src/lib/components/settings/SettingsModal.svelte:472:15
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
            <div class="mb-2 flex items-center justify-between">
              <label class="text-sm font-medium text-surface-300">
                Default Model
              </label>
              <button

/app/src/lib/components/settings/SettingsModal.svelte:530:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Temperature: {settings.apiSettings.temperature.toFixed(1)}
            </label>
            <input

/app/src/lib/components/settings/SettingsModal.svelte:549:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Max Tokens: {settings.apiSettings.maxTokens}
            </label>
            <input

/app/src/lib/components/settings/SettingsModal.svelte:573:19
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                <div>
                  <label class="text-sm font-medium text-surface-300">Extended Thinking</label>
                  <p class="text-xs text-surface-500">

/app/src/lib/components/settings/SettingsModal.svelte:603:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Theme
            </label>
            <select

/app/src/lib/components/settings/SettingsModal.svelte:623:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div>
            <label class="mb-2 block text-sm font-medium text-surface-300">
              Font Size
            </label>
            <select

/app/src/lib/components/settings/SettingsModal.svelte:638:13
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-surface-300">Show Word Count</label>
            <input

/app/src/lib/components/settings/SettingsModal.svelte:651:15
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
            <div>
              <label class="text-sm font-medium text-surface-300">Spellcheck</label>
              <p class="text-xs text-surface-500">Grammar and spelling suggestions while typing</p>

/app/src/lib/components/settings/SettingsModal.svelte:755:19
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                <div>
                  <label class="text-sm font-medium text-surface-300">Check on startup</label>
                  <p class="text-xs text-surface-500">Automatically check for updates when the app opens</p>

/app/src/lib/components/settings/SettingsModal.svelte:775:19
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                <div>
                  <label class="text-sm font-medium text-surface-300">Auto-download updates</label>
                  <p class="text-xs text-surface-500">Download updates automatically in the background</p>

/app/src/lib/components/settings/SettingsModal.svelte:941:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:956:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {processSettings.temperature?.toFixed(2) ?? 0.8}
                          </label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:976:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Max Tokens: {processSettings.maxTokens ?? 1000}
                          </label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:996:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">System Prompt</label>
                          <textarea

/app/src/lib/components/settings/SettingsModal.svelte:1064:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1074:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.classifier.temperature.toFixed(2)}
                      </label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1091:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.classifier.maxTokens}
                    </label>
                    <input

/app/src/lib/components/settings/SettingsModal.svelte:1169:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1179:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.memory.temperature.toFixed(2)}
                      </label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1310:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1320:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.suggestions.temperature.toFixed(2)}
                      </label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1337:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.suggestions.maxTokens}
                    </label>
                    <input

/app/src/lib/components/settings/SettingsModal.svelte:1433:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1443:23
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                    <div>
                      <label class="mb-1 block text-xs font-medium text-surface-400">
                        Temperature: {settings.systemServicesSettings.styleReviewer.temperature.toFixed(2)}
                      </label>
                      <input

/app/src/lib/components/settings/SettingsModal.svelte:1460:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Review Interval: Every {settings.systemServicesSettings.styleReviewer.triggerInterval} messages
                    </label>
                    <input

/app/src/lib/components/settings/SettingsModal.svelte:1480:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div class="mb-3">
                    <label class="mb-1 block text-xs font-medium text-surface-400">
                      Max Tokens: {settings.systemServicesSettings.styleReviewer.maxTokens}
                    </label>
                    <input

/app/src/lib/components/settings/SettingsModal.svelte:1580:21
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                  <div class="mb-3">
                    <label class="mb-2 block text-xs font-medium text-surface-400">Retrieval Mode</label>
                    <div class="flex gap-2">

/app/src/lib/components/settings/SettingsModal.svelte:1623:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:1633:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.timelineFill.temperature.toFixed(2)}
                          </label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:1650:25
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Queries: {settings.systemServicesSettings.timelineFill.maxQueries}
                        </label>
                        <input

/app/src/lib/components/settings/SettingsModal.svelte:1723:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">Model</label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:1733:27
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                        <div>
                          <label class="mb-1 block text-xs font-medium text-surface-400">
                            Temperature: {settings.systemServicesSettings.agenticRetrieval.temperature.toFixed(2)}
                          </label>
                          <input

/app/src/lib/components/settings/SettingsModal.svelte:1749:25
Warn: A form label must be associated with a control
https://svelte.dev/e/a11y_label_has_associated_control (svelte)
                      <div>
                        <label class="mb-1 block text-xs font-medium text-surface-400">
                          Max Iterations: {settings.systemServicesSettings.agenticRetrieval.maxIterations}
                        </label>
                        <input

====================================
svelte-check found 3 errors and 91 warnings in 14 files
